<html>

<head>
  <script type="text/javascript" src="scripts/common-0.0.1.js"></script>
</head>
<style>
  body {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
  }

  #dropBlock {
    /*background-color: gray;
      text-align: center;
      height: 100%;
      width: 100%;
      position: absolute;
      float:left;*/

    width: 100%;
    overflow: hidden;
    position: absolute;
    right: 437px;
    padding-top: 100px;
    text-align: center;
    font-size: 1600%;
    color: #AAA;
  }

  #scripts_endpoints {
    width: 100%;
    height: 100%;
  }

  #scriptContainer {
    width: 35%;
    height: 100%;
    float: left;
  }

  #infoContainer {
    width: 65%;
    height: 100%;
    float: right;
    border-left: 1px;
  }

  .lifolder {
    background: url(data:image/gif;base64,R0lGODlhEAAQAJEDAM2xV/Xur+XPgP///yH5BAEAAAMALAAAAAAQABAAAAJD3ISZIGHWUGihznesYDYATFVM+D2hJ4lgN1olxALAtAlmPCJvuMmJd6PJckDYwicrHhTD5o7plJmg0Uc0asNMkphHAQA7) no-repeat 16px;
    padding-left: 35px;
    cursor: pointer;
    border: none;
    margin-top: 1px;
  }

  .liscript {
    background: url(data:image/gif;base64,R0lGODlhEAAQAJEDAPb19IGBgbq6uv///yH5BAEAAAMALAAAAAAQABAAAAIy3ISpxgcPH2ouQgFEw1YmxnUXKEaaEZZnVWZk66JwzKpvuwZzwOgwb/C1gIOA8Yg8DgoAOw==) no-repeat 16px;
    padding-left: 35px;
    cursor: pointer;
    border: none;
    margin-top: 1px;
  }

  .liselected {
    background-color: lightgray;
  }

  #controlBar {
    width: 100%;
    height: 24px;
    border-bottom: 2px solid #555;
    font-size: smaller;
    margin-bottom: 0;
    background: #eee;
  }

  #controlBar span {
    cursor: pointer;
    padding: 4px 10px;
    display: inline-block;
    border-right: 1px solid #ccc;
    color: #333;
  }

  #controlBar span:hover {
    background: #ddd;
  }

  #controlBar span.tabActive {
    background: #fff;
    font-weight: bold;
    border-bottom: 2px solid #fff;
    color: #000;
  }

  #scriptToolbar span {
    cursor: pointer;
    padding: 3px 7px;
    display: inline-block;
    border-right: 1px solid #ddd;
    color: #333;
  }

  #scriptToolbar span:hover {
    background: #e0e0e0;
  }


  .nIcon {
    width: 16px;
    margin-top: 1px;
    margin-left: 2px;
    height: 16px;
    display: inline-block;
    margin-right: 10px;
  }

  .j1 {
    background: url(../images/icons16.png) 0px 0px;
    height: 16px;
    width: 16px;
    border: none;
  }

  .j2 {
    background: url(../images/icons16.png) -16px 0px;
    height: 16px;
    width: 16px;
    border: none;
  }

  .j3 {
    background: url(../images/icons16.png) -32px 0px;
    height: 16px;
    width: 16px;
    border: none;
  }

  .j4 {
    background: url(../images/icons16.png) -48px 0px;
    height: 16px;
    width: 16px;
    border: none;
  }

  .j5 {
    background: url(../images/icons16.png) -64px 0px;
    height: 16px;
    width: 16px;
    border: none;
  }

  .j6 {
    background: url(../images/icons16.png) -80px 0px;
    height: 16px;
    width: 16px;
    border: none;
  }

  .ftype {
    font-size: small;
  }

  .tblFloat {
    float: left;
    width: 33%;
  }

  .flink {
    cursor: pointer;
  }
</style>

<body onload="doOnLoad();">
  <div id="scriptTaskUser">
    <div id="dropBlock" style="display:none;"><b>&checkmark;</b></div>
    <div id="controlBar">
      <span onclick="goScripts();" id="tabScripts" class="tabActive">Scripts</span>
      <span onclick="goSchedule();" id="tabSchedules">Schedule</span>
      <span onclick="goPolicy();" id="tabPolicies">Policies</span>
      <span onclick="goCompliance();" id="tabCompliance">Compliance</span>
      <span onclick="goSmtp();" id="tabSmtp">Email Notifications</span>
    </div>
    <div id="scripts_endpoints">
      <div id="scriptToolbar"
        style="padding:4px 6px; border-bottom:1px solid #ccc; background:#f5f5f5; font-size:smaller;">
        <span onclick="goNew();">&#43; New</span>
        <span onclick="goNewFolder();">&#128193; New Folder</span>
        <span onclick="goRename();">Rename</span>
        <span onclick="goEdit();">Edit</span>
        <span onclick="goDelete();">Delete</span>
        <span onclick="goDownload();">Download</span>
        <span onclick="goRun();">&#9654; Run</span>
        <span onclick="goScripts();">&#10227; Refresh</span>
        <span style="margin-left:8px;">Upload: <input type="file" id="files" name="files[]" multiple
            onchange="fileUpload();" style="display:inline;font-size:smaller;" /></span>
      </div>
      <div id="scriptContainer">
      </div>
      <div id="infoContainer">
        <div id="history" style="font-family: 'Trebuchet MS', Arial, Helvetica, sans-serif; color:#222;">

          <div class="panel" style="background-color:#f9f9f9; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
            <h3 style="margin-top:0; color:#333;">External Download Server</h3>
            <div id="extDownload">
              <span id="extDownloadUrlText"
                style="display:block; margin-bottom:10px; font-size:13px; word-break:break-all; color:#555;"><i>No
                  External Download URL configured.</i></span>
              <button onclick="promptExtDownloadServer()"
                style="padding:5px 10px; cursor:pointer; background:#007bff; color:#fff; border:none; border-radius:3px;">Set
                URL</button>
            </div>
          </div>

          <div class="panel" style="background-color:#f9f9f9; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
            <h3 style="margin-top:0; color:#333;">Run Now</h3>
            <div id="multiRun">
              <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                <select id="runNowScriptSelect"
                  style="padding:5px; border-radius:3px; border:1px solid #ccc; width:250px;">
                  <option value="">-- Select a Script --</option>
                </select>
                <button onclick="goAdvancedRun();"
                  style="padding:5px 10px; cursor:pointer; background:#28a745; color:#fff; border:none; border-radius:3px;">Run
                  Now</button>
              </div>
              <div style="display:flex; gap:15px;">
                <div style="flex:1; border:1px solid #ccc; background:#fff; padding:10px;">
                  <table id="mRunTbl" style="width:100%; border-collapse:collapse;">
                    <tr>
                      <td style="font-weight:bold; padding-bottom:10px; border-bottom:1px solid #eee;"><label><input
                            type="checkbox" onclick="selAllNodes(this);"> Select All Nodes</label></td>
                    </tr>
                  </table>
                </div>
                <div style="flex:1; border:1px solid #ccc; background:#fff; padding:10px;">
                  <table id="mRunTblMesh" style="width:100%; border-collapse:collapse;">
                    <tr>
                      <td style="font-weight:bold; padding-bottom:10px; border-bottom:1px solid #eee;">Meshes</td>
                    </tr>
                  </table>
                </div>
                <div style="flex:1; border:1px solid #ccc; background:#fff; padding:10px;">
                  <table id="mRunTblTag" style="width:100%; border-collapse:collapse;">
                    <tr>
                      <td style="font-weight:bold; padding-bottom:10px; border-bottom:1px solid #eee;">Tags</td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="panel" style="background-color:#f9f9f9; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
            <h3 style="margin-top:0; color:#333;">Variables</h3>
            <div id="variables">
              <table id="varTbl" style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                <tr style="background:#f0f0f0; text-align:left;">
                  <th style="padding:6px; border:1px solid #ccc;">Variable Name</th>
                  <th style="padding:6px; border:1px solid #ccc;">Value</th>
                  <th style="padding:6px; border:1px solid #ccc;">Scope</th>
                  <th style="padding:6px; border:1px solid #ccc;">Scope Target</th>
                  <th style="padding:6px; border:1px solid #ccc;">Action</th>
                </tr>
              </table>
              <button onclick="newVar();return false;"
                style="padding:5px 10px; cursor:pointer; background:#17a2b8; color:#fff; border:none; border-radius:3px;">+
                Add Variable</button>
            </div>
          </div>

        </div>

      </div>
    </div>

    <div id="schedule_endpoints"
      style="display:none; background-color:#fff; color:#222; padding:20px; min-height:100%; overflow:auto;">
      <style>
        #schedule_endpoints {
          font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
          color: #222;
          background-color: #fff;
        }

        #schedule_endpoints table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }

        #schedule_endpoints th,
        #schedule_endpoints td {
          border: 1px solid #ccc;
          padding: 6px 8px;
          font-size: 14px;
        }

        #schedule_endpoints th {
          background-color: #f0f0f0;
          text-align: left;
          color: #333;
        }

        #schedule_endpoints button,
        #schedule_endpoints input,
        #schedule_endpoints select {
          padding: 5px;
          font-family: inherit;
        }

        #schedule_endpoints button {
          cursor: pointer;
        }

        #schedule_endpoints .panel {
          background-color: #f9f9f9;
          padding: 15px;
          margin-bottom: 20px;
          border: 1px solid #ddd;
        }

        #schedule_endpoints .hidden {
          display: none;
        }

        #schedule_endpoints h2,
        #schedule_endpoints h3 {
          margin-top: 0;
          color: #333;
        }

        #schedule_endpoints .flink {
          color: #0066cc;
          cursor: pointer;
          text-decoration: underline;
        }

        #schedule_endpoints .form-row {
          margin-bottom: 10px;
        }

        #schedule_endpoints .form-row label {
          display: inline-block;
          width: 150px;
          color: #444;
        }

        #schedule_endpoints .main-container {
          display: flex;
          gap: 20px;
        }

        #schedule_endpoints .col {
          flex: 1;
        }
      </style>
      <div class="main-container">
        <div class="col" id="colScheduleList">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>Schedules</h2>
            <button onclick="showScheduleForm();"
              style="padding: 8px 15px; background: #007bff; color: white; border: none; font-weight: bold; border-radius:3px;">+
              New Schedule</button>
          </div>
          <p style="color:#555; font-size:14px; margin-top:-10px; margin-bottom:15px;">Run scripts automatically on a
            cron schedule.</p>
          <div class="panel">
            <table id="tblSchedules">
              <thead>
                <tr>
                  <th>Schedule Name</th>
                  <th>Scripts</th>
                  <th>Cron</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tblSchedulesBody">
                <tr>
                  <td colspan="4" style="color:#999;font-style:italic;">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="col hidden" id="colEditSchedule">
          <h2 id="editScheduleTitle">Edit Schedule</h2>
          <div class="panel">
            <input type="hidden" id="sId" value="" />
            <div class="form-row">
              <label>Name:</label>
              <input type="text" id="sName" style="width: 250px;" />
            </div>
            <div class="form-row">
              <label>Script(s):</label>
              <select id="sScripts" style="width: 250px;" multiple size="6">
              </select>
              <br /><small style="margin-left:154px; color:#666;">Hold Ctrl to select multiple</small>
            </div>
            <div class="form-row" style="margin-top:20px; border-top:1px solid #ddd; padding-top:15px;">
              <h4 style="margin:0 0 10px 0;">Cron Expression</h4>
              <p style="font-size:12px; color:#555; margin-top:0;">* = any, */5 = every 5, 1,2 = list, 1-5 = range</p>

              <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="flex:1;">
                  <label style="width:auto; display:block; font-size:12px;">Min (0-59)</label>
                  <input type="text" id="sCronMin" style="width:100%;" value="*" />
                </div>
                <div style="flex:1;">
                  <label style="width:auto; display:block; font-size:12px;">Hour (0-23)</label>
                  <input type="text" id="sCronHour" style="width:100%;" value="*" />
                </div>
                <div style="flex:1;">
                  <label style="width:auto; display:block; font-size:12px;">Day of Month (1-31)</label>
                  <input type="text" id="sCronDom" style="width:100%;" value="*" />
                </div>
                <div style="flex:1;">
                  <label style="width:auto; display:block; font-size:12px;">Month (1-12)</label>
                  <input type="text" id="sCronMonth" style="width:100%;" value="*" />
                </div>
                <div style="flex:1;">
                  <label style="width:auto; display:block; font-size:12px;">Day of Week (0-6 Sun-Sat)</label>
                  <input type="text" id="sCronDow" style="width:100%;" value="*" />
                </div>
              </div>
            </div>

            <div class="form-row" style="margin-top:20px; border-top:1px solid #ddd; padding-top:15px;">
              <h4 style="margin:0 0 10px 0;">Email Notifications</h4>
              <div class="form-row">
                <label style="width: 200px;">Notify on Completion:</label>
                <input type="checkbox" id="sNotify" />
              </div>
              <div class="form-row">
                <label style="width: 200px;">Only if Exit Code:</label>
                <select id="sNotifyCondition" style="width: 60px;">
                  <option value="any">Any</option>
                  <option value="==">==</option>
                  <option value="!=">!=</option>
                  <option value=">">&gt;</option>
                  <option value="<">&lt;</option>
                </select>
                <input type="number" id="sNotifyCode" style="width: 60px;" placeholder="0" />
              </div>
            </div>

            <div style="margin-top: 25px;">
              <button onclick="saveSchedule();"
                style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:3px;">Save</button>
              <button onclick="cancelEditSchedule();"
                style="border:1px solid #ccc; padding:7px 15px; border-radius:3px; margin-left:10px;">Cancel</button>
            </div>
          </div>
        </div>

        <div class="col hidden" id="colAssignSchedule">
          <h2 id="assignScheduleTitle">Assign Schedule</h2>
          <div class="panel">
            <div class="form-row">
              <label>Target Type:</label>
              <select id="saTargetType" onchange="updateScheduleTargetList();">
                <option value="node">Individual Computer</option>
                <option value="mesh">Device Group (Mesh)</option>
                <option value="tag">Device Tag</option>
              </select>
            </div>
            <div class="form-row">
              <label>Target:</label>
              <select id="saTargetId" style="width: 250px;"></select>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="saveScheduleAssignment();"
                style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:3px;">Assign</button>
              <button onclick="cancelAssignSchedule();"
                style="border:1px solid #ccc; padding:7px 15px; border-radius:3px; margin-left:10px;">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="policy_endpoints"
      style="display:none; background-color:#fff; color:#222; padding:20px; min-height:100%; overflow:auto;">
      <style>
        #policy_endpoints {
          font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
          color: #222;
          background-color: #fff;
        }

        #policy_endpoints table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }

        #policy_endpoints th,
        #policy_endpoints td {
          border: 1px solid #ccc;
          padding: 6px 8px;
          font-size: 14px;
        }

        #policy_endpoints th {
          background-color: #f0f0f0;
          text-align: left;
          color: #333;
        }

        #policy_endpoints button,
        #policy_endpoints input,
        #policy_endpoints select {
          padding: 5px;
          font-family: inherit;
        }

        #policy_endpoints button {
          cursor: pointer;
        }

        #policy_endpoints .panel {
          background-color: #f9f9f9;
          padding: 15px;
          margin-bottom: 20px;
          border: 1px solid #ddd;
        }

        #policy_endpoints .hidden {
          display: none;
        }

        #policy_endpoints h2,
        #policy_endpoints h3 {
          margin-top: 0;
          color: #333;
        }

        #policy_endpoints .flink {
          color: #0066cc;
          cursor: pointer;
          text-decoration: underline;
        }

        #policy_endpoints .form-row {
          margin-bottom: 10px;
        }

        #policy_endpoints .form-row label {
          display: inline-block;
          width: 150px;
          color: #444;
        }

        #policy_endpoints .main-container {
          display: flex;
          gap: 20px;
        }

        #policy_endpoints .col {
          flex: 1;
        }
      </style>
      <div class="main-container">


        <div class="col" id="colList">
          <h2>Policies</h2>
          <div class="panel">
            <button onclick="showEditForm(null);">+ Create New Policy</button>
            <table id="tblPolicies">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Enabled</th>
                  <th>Detect Script</th>
                  <th>Remediate Script</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tblPoliciesBody">
                <tr>
                  <td colspan="5">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="panel" id="pnlAssignments" style="display:none;">
            <h3>Assignments for: <span id="lblAssignedPolicyName"></span></h3>
            <button onclick="showAssignForm();" id="btnAssign">+ New Assignment</button>
            <table id="tblAssignments">
              <thead>
                <tr>
                  <th>Target Type</th>
                  <th>Target Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tblAssignmentsBody">
                <tr>
                  <td colspan="3">None</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="col hidden" id="colEdit">
          <h2 id="editTitle">Edit Policy</h2>
          <div class="panel">
            <input type="hidden" id="pId" value="" />
            <div class="form-row">
              <label>Name:</label>
              <input type="text" id="pName" style="width: 250px;" />
            </div>
            <div class="form-row">
              <label>Enabled:</label>
              <input type="checkbox" id="pEnabled" checked />
            </div>
            <div class="form-row">
              <label
                title="Detection scripts MUST exit with code 0 if the device is Compliant, and any non-zero exit code (e.g. 1) if it is Non-Compliant.">Detect
                Script ℹ️:</label>
              <select id="pDetect" style="width: 250px;">
                <option value="">(None)</option>
              </select>
            </div>
            <div class="form-row">
              <label>Remediate Script:</label>
              <select id="pRemediate" style="width: 250px;">
                <option value="">(None optional)</option>
              </select>
            </div>
            <div class="form-row">
              <label>Cooldown (Mins):</label>
              <input type="number" id="pCooldown" value="60" style="width: 80px;" />
              <small>Min time between runs per device</small>
            </div>
            <div class="form-row">
              <label>Notify on Failure:</label>
              <input type="checkbox" id="pNotify" checked />
            </div>
            <div class="form-row">
              <label>Notify on Success:</label>
              <input type="checkbox" id="pNotifySuccess" />
            </div>
            <div style="margin-top: 15px;">
              <button onclick="savePolicy();">Save</button>
              <button onclick="cancelEdit();">Cancel</button>
              <button onclick="testNotification();" id="btnTestNotify"
                style="margin-left:20px; background:#47a; color:#fff; border:1px solid #7af;">Test Alert
                Email</button>
            </div>
          </div>
        </div>

        <div class="col hidden" id="colAssign">
          <h2 id="assignTitle">Assign Policy</h2>
          <div class="panel">
            <div class="form-row">
              <label>Target Type:</label>
              <select id="aTargetType" onchange="updateTargetList();">
                <option value="node">Individual Computer</option>
                <option value="mesh">Device Group (Mesh)</option>
                <option value="tag">Device Tag</option>
              </select>
            </div>
            <div class="form-row">
              <label>Target:</label>
              <select id="aTargetId" style="width: 250px;"></select>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="saveAssignment();">Assign</button>
              <button onclick="cancelAssign();">Cancel</button>
            </div>
          </div>
        </div>


      </div>
    </div>

    <div id="compliance_endpoints"
      style="display:none; background-color:#fff; color:#222; padding:20px; min-height:100%; overflow:auto;">
      <style>
        #compliance_endpoints table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 8px;
        }

        #compliance_endpoints th,
        #compliance_endpoints td {
          border: 1px solid #ccc;
          padding: 6px 8px;
          font-size: 13px;
        }

        #compliance_endpoints th {
          background: #f0f0f0;
          color: #333;
          text-align: left;
        }

        #compliance_endpoints .cev-panel {
          background: #f9f9f9;
          border: 1px solid #ddd;
          padding: 15px;
          margin-bottom: 16px;
        }

        #compliance_endpoints h2,
        #compliance_endpoints h3 {
          margin-top: 0;
          color: #333;
        }

        #compliance_endpoints .flink {
          color: #0066cc;
          cursor: pointer;
          text-decoration: underline;
        }

        #compliance_endpoints .cev-section-title {
          font-weight: bold;
          margin: 14px 0 4px;
          color: #555;
          font-size: 12px;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        #compliance_endpoints .cev-tag {
          display: inline-block;
          padding: 2px 7px;
          border-radius: 10px;
          font-size: 11px;
          background: #e8f4e8;
          color: #2a6;
          border: 1px solid #bde;
          margin-left: 6px;
        }

        #compliance_endpoints input[type=number],
        #compliance_endpoints select {
          padding: 4px 6px;
          border: 1px solid #ccc;
          border-radius: 3px;
        }

        #compliance_endpoints button {
          padding: 5px 14px;
          border: none;
          border-radius: 3px;
          cursor: pointer;
        }
      </style>

      <!-- Overview Panel -->
      <div id="cev-overview">
        <h2>Compliance <span style="font-size:14px;font-weight:normal;color:#888;">— Device Overview</span>
          <button onclick="goCompliance()"
            style="float:right; margin-top:-2px; padding:3px 8px; font-size:12px; cursor:pointer;">&#10227;
            Refresh</button>
        </h2>
        <div style="margin-bottom:8px; display:flex; gap:10px; align-items:center;">
          <input type="text" id="cev-search" placeholder="Search by device, description, or user..."
            oninput="filterComplianceOverview()"
            style="padding:5px 8px; border:1px solid #ccc; border-radius:3px; width:240px; font-size:13px;">
          <button onclick="complianceSearchCurrent()"
            style="padding:4px 8px; font-size:12px; cursor:pointer; background:#17a2b8; color:#fff; border:none; border-radius:3px;">Find
            Current</button>
        </div>
        <div class="cev-panel">
          <table id="cev-overview-tbl">
            <thead>
              <tr>
                <th onclick="sortComplianceOverview('name')" style="cursor:pointer;">Device &#9660;</th>
                <th onclick="sortComplianceOverview('desc')" style="cursor:pointer;">Description &#9660;</th>
                <th onclick="sortComplianceOverview('user')" style="cursor:pointer;">Last User &#9660;</th>
                <th>Last IP <span style="font-size:11px;font-weight:normal;">(seen)</span></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="cev-overview-body">
              <tr>
                <td colspan="5" style="color:#999;font-style:italic;">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Retention Settings (collapsible) -->
        <details style="margin-top:10px;">
          <summary style="cursor:pointer;font-weight:bold;color:#555;">&#9881; Retention Settings</summary>
          <div class="cev-panel" style="margin-top:8px;" id="cev-retention-panel">
            <div class="cev-section-title">Default Retention (days)</div>
            <table style="width:auto;">
              <thead>
                <tr>
                  <th>Event Type</th>
                  <th>Days</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cev-retention-defaults">
                <tr>
                  <td>IP Seen</td>
                  <td><input type="number" id="ret-ip-days" min="1" value="90" style="width:70px;"></td>
                  <td><button onclick="saveDefaultRetention('ipSeen')"
                      style="background:#007bff;color:#fff;">Save</button></td>
                </tr>
                <tr>
                  <td>Last User</td>
                  <td><input type="number" id="ret-user-days" min="1" value="90" style="width:70px;"></td>
                  <td><button onclick="saveDefaultRetention('lastUser')"
                      style="background:#007bff;color:#fff;">Save</button></td>
                </tr>
                <tr>
                  <td>Power History</td>
                  <td><input type="number" id="ret-power-days" min="1" value="180" style="width:70px;"></td>
                  <td><button onclick="saveDefaultRetention('powerHistory')"
                      style="background:#007bff;color:#fff;">Save</button></td>
                </tr>
              </tbody>
            </table>

            <div class="cev-section-title" style="margin-top:14px;">Scoped Overrides
              <button onclick="addRetentionOverride()"
                style="background:#28a745;color:#fff;margin-left:10px;font-size:11px;">+ Add Override</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Event Type</th>
                  <th>Scope</th>
                  <th>Target</th>
                  <th>Days</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cev-retention-overrides"></tbody>
            </table>
          </div>
        </details>
      </div>

      <!-- Detail Drill-down Panel -->
      <div id="cev-detail" style="display:none;">
        <div style="float: right;">
          <span class="flink" style="font-size:16px;" onclick="goCompliance();">&#10006;</span>
        </div>
        <div style="margin-bottom:10px;">
          <span class="flink" onclick="showComplianceOverview();">&#8592; Back to Overview</span>
          &nbsp; <strong id="cev-detail-name" style="font-size:16px;"></strong>
        </div>
        <div class="cev-panel">
          <div class="cev-section-title">&#128205; IP Address History <button
              onclick="downloadSpecificTableCSV('cev-ip-tbl', 'IP Address History')"
              style="float:right; font-size:11px; padding:2px 6px; cursor:pointer; background:#17a2b8; color:#fff; border:none; border-radius:3px;">&#8681;
              CSV</button></div>
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>IP Address</th>
              </tr>
            </thead>
            <tbody id="cev-ip-tbl"></tbody>
          </table>
          <div class="cev-section-title" style="margin-top:14px;">&#128100; User History <button
              onclick="downloadSpecificTableCSV('cev-user-tbl', 'User History')"
              style="float:right; font-size:11px; padding:2px 6px; cursor:pointer; background:#17a2b8; color:#fff; border:none; border-radius:3px;">&#8681;
              CSV</button></div>
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Username</th>
              </tr>
            </thead>
            <tbody id="cev-user-tbl"></tbody>
          </table>
          <div class="cev-section-title" style="margin-top:14px;" id="cev-power-title">
            &#9889; Power History
            <button onclick="downloadPowerHistoryCSV()"
              style="float:right; font-size:11px; padding:2px 6px; cursor:pointer; background:#17a2b8; color:#fff; border:none; border-radius:3px; margin-left:6px;">
              &#8681; CSV</button>
          </div>
          <!-- Paginated state-transition table -->
          <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-size:12px;">
            <button id="cev-pwr-prev" onclick="pwrPageNav(-1)" style="padding:2px 7px; font-size:12px;">&laquo;
              Prev</button>
            <span id="cev-pwr-pageinfo" style="color:#666;"></span>
            <button id="cev-pwr-next" onclick="pwrPageNav(1)" style="padding:2px 7px; font-size:12px;">Next
              &raquo;</button>
            <span id="cev-pwr-count" style="margin-left:auto; color:#999;"></span>
          </div>
          <!-- Alert on State Change -->
          <div
            style="margin-bottom:8px; padding:6px 8px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; font-size:12px; display:flex; align-items:center; gap:8px;">
            <span title="Sends an email when this device's power state changes">&#9993;</span>
            <label style="cursor:pointer; user-select:none;">
              <input type="checkbox" id="cev-pwr-alert-chk" onchange="savePwrAlertConfig()" style="margin-right:4px;">
              Alert on State Change — email when this device's power state changes
            </label>
            <span id="cev-pwr-alert-status" style="color:#999; font-size:11px; margin-left:auto;"></span>
          </div>
          <table style="width:100%;">
            <thead>
              <tr>
                <th>State Entered</th>
                <th>Power State</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody id="cev-power-tbl"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="smtp_endpoints" style="display:none; background-color:#fff; min-height:100%; overflow:auto;">
      <div id="smtpPanel" style="padding: 20px; font-family: Arial, sans-serif;">
        <h2>Email Notifications (SMTP Configuration)</h2>
        <p>Configure custom SMTP settings for the Compliance Engine. If left blank, the plugin will attempt to use the
          MeshCentral server's core SMTP config.</p>

        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">Host/Server:</label>
          <input type="text" id="sHost" style="width: 250px;" placeholder="smtp.example.com" />
        </div>
        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">Port:</label>
          <input type="number" id="sPort" style="width: 80px;" placeholder="587" />
        </div>
        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">Username:</label>
          <input type="text" id="sUser" style="width: 250px;" />
        </div>
        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">Password:</label>
          <input type="password" id="sPass" style="width: 250px;" />
        </div>
        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">From Address:</label>
          <input type="text" id="sFrom" style="width: 250px;" placeholder="noreply@example.com" />
        </div>
        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">To Address:</label>
          <input type="text" id="sTo" style="width: 250px;" placeholder="admin@example.com" />
        </div>
        <div class="form-row" style="margin-bottom: 10px;">
          <label style="display:inline-block; width:120px;">Enable TLS/SSL:</label>
          <input type="checkbox" id="sTls" />
        </div>

        <div style="margin-top: 20px;">
          <button onclick="saveSmtp();"
            style="padding: 5px 15px; background: #007bff; color: white; border: none; cursor: pointer;">Save
            Settings</button>
          <button onclick="testSmtp();"
            style="padding: 5px 15px; margin-left: 10px; background: #28a745; color: white; border: none; cursor: pointer;">Test
            Email</button>
        </div>
      </div>
    </div>
  </div>


  <script type="text/javascript">
    var _policies = [];
    var _assignments = [];
    var _currentPolicyId = null;

    function doOnLoadPolicy() {
      if (!parent || !parent.meshserver) {
        document.getElementById('tblPoliciesBody').innerHTML = `<tr>
            <td colspan="5" style="color:red; font-weight:bold;">Error: Unable to connect to MeshCentral Server.</td>
          </tr>`;
        return;
      }
      populateScriptDropdowns();
      refreshData();
    }

    function refreshData() {
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getPolicies' });
    }

    function loadPolicyData(policies, assignments, error) {
      console.log("loadPolicyData called with:", policies, assignments, error);
      if (error) {
        document.getElementById('tblPoliciesBody').innerHTML = `<tr>
            <td colspan="5" style="color:red; font-weight:bold;">Error Loading Policies: ${error}</td>
          </tr>`;
        return;
      }
      _policies = policies || [];
      _assignments = assignments || [];
      renderPolicies();
      if (_currentPolicyId) {
        viewAssignments(_currentPolicyId);
      }
    };

    function populateScriptDropdowns() {
      var selD = document.getElementById('pDetect');
      var selR = document.getElementById('pRemediate');
      selD.innerHTML = '<option value="">(Select Detection Script)</option>';
      selR.innerHTML = '<option value="">(None - Detection Only)</option>';

      var sTree = scriptTree || [];
      sTree.forEach(function (s) {
        if (s.type === 'script') {
          selD.options.add(new Option(s.name, s._id));
          selR.options.add(new Option(s.name, s._id));
        }
      });
    }

    function getScriptName(id) {
      if (!id) return "None";
      var sTree = scriptTree || [];
      var s = sTree.find(x => x._id === id);
      return s ? s.name : "Unknown (" + id + ")";
    }

    function renderPolicies() {
      var tbody = document.getElementById('tblPoliciesBody');
      tbody.innerHTML = '';
      if (_policies.length === 0) {
        tbody.innerHTML = `<tr>
            <td colspan="5">No policies found.</td>
          </tr>`;
        return;
      }

      _policies.forEach(function (p) {
        var tr = document.createElement('tr');
        tr.innerHTML = `
    <td><b>${p.name}</b><br /><small>v${p.version || 1}</small></td>
    <td>${p.enabled ? 'Yes' : 'No'}</td>
    <td>${getScriptName(p.detectScriptId)}</td>
    <td>${getScriptName(p.remediateScriptId)}</td>
    <td>
      <span class="flink" onclick="viewAssignments('${p._id}', '${p.name.replace(/'/g, " '")}');">Assignments</span> |
      <span class="flink" onclick="showEditForm('${p._id}');">Edit</span> |
      <span class="flink" style="color:#f88" onclick="deletePolicy('${p._id}');">Delete</span>
    </td>
    `;
        tbody.appendChild(tr);
      });
    }

    function showEditForm(id) {
      document.getElementById('colEdit').classList.remove('hidden');
      document.getElementById('colAssign').classList.add('hidden');

      if (id) {
        var p = _policies.find(x => x._id === id);
        document.getElementById('editTitle').innerText = 'Edit Policy';
        document.getElementById('pId').value = p._id;
        document.getElementById('pName').value = p.name;
        document.getElementById('pEnabled').checked = p.enabled;
        document.getElementById('pDetect').value = p.detectScriptId || '';
        document.getElementById('pRemediate').value = p.remediateScriptId || '';
        document.getElementById('pCooldown').value = p.cooldownMinutes || 60;
        document.getElementById('pNotify').checked = p.notifyOnFail;
        document.getElementById('pNotifySuccess').checked = !!p.notifyOnSuccess;
      } else {
        document.getElementById('editTitle').innerText = 'Create New Policy';
        document.getElementById('pId').value = '';
        document.getElementById('pName').value = 'New Compliance Policy';
        document.getElementById('pEnabled').checked = true;
        document.getElementById('pDetect').value = '';
        document.getElementById('pRemediate').value = '';
        document.getElementById('pCooldown').value = 60;
        document.getElementById('pNotify').checked = true;
        document.getElementById('pNotifySuccess').checked = false;
      }
    }

    function cancelEdit() {
      document.getElementById('colEdit').classList.add('hidden');
    }

    function savePolicy() {
      if (!document.getElementById('pDetect').value) {
        alert("A Detect Script is required!");
        return;
      }
      var p = {
        name: document.getElementById('pName').value,
        enabled: document.getElementById('pEnabled').checked,
        detectScriptId: document.getElementById('pDetect').value,
        remediateScriptId: document.getElementById('pRemediate').value,
        cooldownMinutes: parseInt(document.getElementById('pCooldown').value) || 60,
        notifyOnFail: document.getElementById('pNotify').checked,
        notifyOnSuccess: document.getElementById('pNotifySuccess').checked
      };
      var id = document.getElementById('pId').value;
      if (id) p._id = id;

      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'savePolicy', policy: p });
      cancelEdit();
    }

    function deletePolicy(id) {
      if (confirm('Are you sure you want to delete this policy? Assignments and state history will also be removed.')) {
        parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'deletePolicy', id: id });
        if (_currentPolicyId === id) {
          document.getElementById('pnlAssignments').style.display = 'none'; _currentPolicyId =
            null;
        }
      }
    }

    function viewAssignments(id, name) {
      _currentPolicyId = id;
      if (name) document.getElementById('lblAssignedPolicyName').innerText = name;
      document.getElementById('pnlAssignments').style.display = 'block';
      document.getElementById('colAssign').classList.add('hidden');

      var tbody = document.getElementById('tblAssignmentsBody');
      tbody.innerHTML = '';

      var myAssigns = _assignments.filter(x => x.policyId === id);
      if (myAssigns.length === 0) {
        tbody.innerHTML = `<tr>
            <td colspan="3">No assignments. Policy is inactive.</td>
          </tr>`;
        return;
      }

      myAssigns.forEach(function (a) {
        var tr = document.createElement('tr');
        var targetName = a.targetId;
        if (a.targetType === 'node' && parent.nodes) {
          var n = parent.nodes.find(x => x._id === a.targetId);
          if (n) targetName = n.name;
        } else if (a.targetType === 'mesh' && parent.meshes) {
          var m = parent.meshes[a.targetId];
          if (m) targetName = m.name;
        }

        tr.innerHTML = `
      <td>${a.targetType}</td>
      <td>${targetName}</td>
      <td><span class="flink" style="color:#f88" onclick="deleteAssignment('${a._id}');">Remove</span></td>
      `;
        tbody.appendChild(tr);
      });
    }

    function showAssignForm() {
      if (!_currentPolicyId) return;
      document.getElementById('colAssign').classList.remove('hidden');
      updateTargetList();
    }

    function cancelAssign() {
      document.getElementById('colAssign').classList.add('hidden');
    }

    function testNotification() {
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'testComplianceNotify' });
      alert(`A test notification command has been sent to the MeshCentral server. If email is configured, it should
      arrive shortly.`);
    }

    function updateTargetList() {
      var type = document.getElementById('aTargetType').value;
      var sel = document.getElementById('aTargetId');
      sel.innerHTML = '';

      if (type === 'node') {
        var nodes = parent.nodes || [];
        nodes.forEach(function (n) {
          if (n.mtype === 2) sel.options.add(new Option(n.name, n._id));
        });
      } else if (type === 'mesh') {
        var meshes = parent.meshes || {};
        for (var key in meshes) {
          if (meshes[key].mtype === 2) sel.options.add(new Option(meshes[key].name, key));
        }
      } else if (type === 'tag') {
        sel.options.add(new Option("Please enter the precise Tag string here ->", ""));
        // Meshcentral tags are stored differently, usually we rely on the backend to parse them
        // We will just let the user type out the tag name manually, or prompt them:
        var tagName = prompt("Enter the exact name of the Device Tag to assign this policy to:");
        if (tagName) {
          sel.options.add(new Option("Tag: " + tagName, tagName));
          sel.value = tagName;
        }
      }
    }

    function saveAssignment() {
      var typ = document.getElementById('aTargetType').value;
      var tid = document.getElementById('aTargetId').value;
      if (!tid) return;

      var a = {
        policyId: _currentPolicyId,
        targetType: typ,
        targetId: tid
      };
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'savePolicyAssignment', assignment:
          a
      });
      cancelAssign();
    }

    function deleteAssignment(id) {
      if (confirm('Remove assignment?')) {
        parent.meshserver.send({
          action: 'plugin', plugin: 'scripttask', pluginaction: 'deletePolicyAssignment', id: id
        });
      }
    }



    function loadSmtpData(config, error) {
      if (error) { alert("Error loading SMTP config: " + error); return; }
      if (!config) config = {};
      document.getElementById('sHost').value = config.host || '';
      document.getElementById('sPort').value = config.port || '';
      document.getElementById('sUser').value = config.user || '';
      document.getElementById('sPass').value = config.pass || '';
      document.getElementById('sFrom').value = config.from || '';
      document.getElementById('sTo').value = config.toAddress || '';
      document.getElementById('sTls').checked = config.tls || config.tlsstrict || false;
    }

    function saveSmtp() {
      var conf = {
        host: document.getElementById('sHost').value,
        port: parseInt(document.getElementById('sPort').value) || 587,
        user: document.getElementById('sUser').value,
        pass: document.getElementById('sPass').value,
        from: document.getElementById('sFrom').value,
        toAddress: document.getElementById('sTo').value,
        tls: document.getElementById('sTls').checked
      };
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'saveSmtpConfig', config: conf });
      alert("SMTP Settings Saved!");
      goScripts();
    }

    function testSmtp() {
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'testComplianceNotify' });
      alert("A test email has been dispatched. If settings are correct, it should arrive momentarily.");
    }




    function setActiveTab(id) {
      ['tabScripts', 'tabSchedules', 'tabPolicies', 'tabCompliance', 'tabSmtp'].forEach(function (t) {
        var el = document.getElementById(t);
        if (el) el.classList.remove('tabActive');
      });
      var active = document.getElementById(id);
      if (active) active.classList.add('tabActive');
    }

    function goScripts() {
      document.getElementById('schedule_endpoints').style.display = 'none';
      document.getElementById('policy_endpoints').style.display = 'none';
      document.getElementById('smtp_endpoints').style.display = 'none';
      document.getElementById('compliance_endpoints').style.display = 'none';
      document.getElementById('scripts_endpoints').style.display = 'block';
      setActiveTab('tabScripts');
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getScripts' });
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getExternalDownloadServer' });
      resizeIframe();
    }

    var scriptTree = {{{ scriptTree }}};
    var elementDragged = false;
    var dragCounter = 0;
    var draggedId = null;
    var nodesObj = {};
    var variables = [];
    var varScopes = { global: 'Global', script: 'Script', mesh: 'Mesh', node: 'Node' };

    function onlyUnique(value, index, self) {
      return self.indexOf(value) === index;
    }
    function resizeIframe() {
      // Do NOT set body.style.height = 0 — this collapses the iframe and causes
      // a visible bounce/flash on the My Devices page while it re-expands.
      // Instead, let the parent measure the actual content height.
      if (typeof parent !== 'undefined' && parent.pluginHandler &&
        parent.pluginHandler.scripttask && typeof parent.pluginHandler.scripttask.resizeContent === 'function') {
        parent.pluginHandler.scripttask.resizeContent();
      }
    }
    function updateNodesTable() {
      let dRows = document.querySelectorAll('.stNodeRow');
      dRows.forEach((r) => {
        r.parentNode.removeChild(r);
      });
      var tagList = [];
      var nodeRowIns = document.querySelector('#mRunTbl');
      var nodesToProcess = [];
      if (parent.nodes) {
        if (Array.isArray(parent.nodes)) {
          parent.nodes.forEach(function (n) { nodesToProcess.push(n); });
        } else {
          for (var key in parent.nodes) nodesToProcess.push(parent.nodes[key]);
        }
      } else if (parent.currentNode) {
        nodesToProcess.push(parent.currentNode);
      }
      if (nodesToProcess.length > 0) {
        nodesToProcess.forEach(function (i) {
          var item = { ...i, ...{} };
          if (item._id && (item.mtype == 2 || item.mtype == 3 || item.mtype == 1 || item._id.startsWith('node//') || (parent.currentNode && item._id === parent.currentNode._id))) {
            if (parent.meshes && item['meshid'] && parent.meshes[item['meshid']]) {
              item.meshName = parent.meshes[item['meshid']].name;
            } else {
              item.meshName = 'Unknown';
            }
            if (parent.currentNode && item._id == parent.currentNode._id) item.checked = 'checked '; else item.checked = '';
            let tpl = `<tr class="stNodeRow">
          <td><label><input type="checkbox" ${item.checked} name="runOn[]" value="${item._id}">
              <div class="nIcon j${item.icon || 1}"></div>${item.name || item._id.split('/')[2]}
            </label></td>
          </tr> `;
            nodeRowIns.insertAdjacentHTML('beforeend', tpl);
            if (i.tags && i.tags.length) item.tags.forEach(function (t) { tagList.push(t) });
            nodesObj[i._id] = i;
          }
        });
      }
      tagList = tagList.filter(onlyUnique); tagList = tagList.sort();
      var nodeRowInsMesh = document.querySelector('#mRunTblMesh');
      if (parent.meshes) {
        for (const i in parent.meshes) { // parent.meshes.forEach(function(i) {
          var item = { ...parent.meshes[i], ...{} };
          if (item.mtype == 2) {
            let tpl = `<tr class="stNodeRow">
            <td><label><input type="checkbox" onclick="selNodesByMesh(this);" value="${item._id}"> ${item.name}</label>
            </td>
            </tr> `;
            nodeRowInsMesh.insertAdjacentHTML('beforeend', tpl);
          }
        }
      }
      var nodeRowInsTag = document.querySelector('#mRunTblTag');
      tagList.forEach(function (i) {
        let tpl = `<tr class="stNodeRow">
            <td><label><input type="checkbox" onclick="selNodesByTag(this)" value="${i}"> ${i}</label></td>
            </tr> `;
        nodeRowIns.insertAdjacentHTML('beforeend', tpl);
      });
    }

    function selNodesByTag(el) {
      var t = el.value;
      var allNodes = Q('mRunTbl').querySelectorAll('input[type="checkbox"][name="runOn[]"]');
      var checked = false;
      if (el.checked) checked = true;
      allNodes.forEach(function (n) {
        if (nodesObj[n.value].tags && nodesObj[n.value].tags.indexOf(t) > -1) n.checked = checked;
      });
      return true;
    }
    function selNodesByMesh(el) {
      var mid = el.value;
      var allNodes = Q('mRunTbl').querySelectorAll('input[type="checkbox"][name="runOn[]"]');
      var checked = false;
      if (el.checked) checked = true;
      allNodes.forEach(function (n) {
        if (nodesObj[n.value].meshid == mid) n.checked = checked;
      });
      return true;
    }
    function selAllNodes(el) {
      var allNodes = Q('mRunTbl').querySelectorAll('input[type="checkbox"][name="runOn[]"]');
      var checked = false;
      if (el.checked) checked = true;
      allNodes.forEach(function (n) {
        n.checked = checked;
      });
      return true;
    }

    function redrawScriptTree() {
      var lastpath = null;
      var str = '';
      var indent = 0;
      var folder_id = null;
      str += '<div style="display: block;overflow-y: auto;max-height: 700px;">'
      scriptTree.forEach(function (f) {
        if (f.path != lastpath && f.type == 'folder') {
          indent = (f.path.match(/\//g) || []).length + 1;
          var name = f.path.match(/[^\/]+$/);
          folder_id = f._id;
          str += '<div draggable="true" x-data-path="' + f.path + '" x-data-id="' + f._id + '" x-data-folder="' + folder_id + '" style="margin-left: ' + indent + 'em;" class="lifolder" onclick="toggleCollapse(this);"><span class="fname">' + name + '</span></div>';
          lastpath = f.path;
          indent += 1;
        }
        if (f.type != 'folder') {
          str += '<div id="' + f._id + '" draggable="true"  x-data-path="' + f.path + '" x-data-id="' + f._id + '" x-data-folder="' + folder_id + '" style="margin-left: ' + indent + 'em;" class="liscript" onclick="goScript(this);"><span class="fname">' + f.name + '</span> [<span class="ftype">' + f.filetype + '</span>]</div>';
        }
      });
      str += '</div>';
      document.getElementById('scriptContainer').innerHTML = str;
      var liScripts = document.querySelectorAll('.liscript');
      var liFolders = document.querySelectorAll('.lifolder');
      liScripts.forEach(function (el) {
        el.addEventListener('mousedown', function () { elementDragged = true; });
        el.addEventListener('mouseup', function () { elementDragged = false; });
        el.addEventListener('dragstart', function (evt) { evt.dataTransfer.setData('text/plain', evt.target.getAttribute('x-data-id')); });
      });
      liFolders.forEach(function (el) {
        el.addEventListener('drop', dropMove);
        el.addEventListener('dragover', function (e) { e.preventDefault(); });
        el.addEventListener('mousedown', function () { elementDragged = true; });
        el.addEventListener('mouseup', function () { elementDragged = false; });
        el.addEventListener('dragstart', function (evt) { evt.dataTransfer.setData('text/plain', evt.target.getAttribute('x-data-id')); });
      });
      resizeIframe();
      selectPreviouslySelectedScript();

      var rnSelect = document.getElementById('runNowScriptSelect');
      if (rnSelect) {
        rnSelect.innerHTML = '<option value="">-- Select a Script --</option>';
        scriptTree.filter(function (sc) { return sc.type !== 'folder'; }).forEach(function (sc) {
          rnSelect.options.add(new Option(sc.name, sc._id));
        });
      }
    }

    parent.pluginHandler.scripttask.newScriptTree = function (message) {
      scriptTree = message.event.tree;
      redrawScriptTree();
    }

    function doOnLoad() {
      redrawScriptTree();
      selectPreviouslySelectedScript();
      updateNodesTable();
      if (parent.currentNode) {
        parent.meshserver.send({
          'action': 'plugin', 'plugin': 'scripttask', 'pluginaction': 'loadNodeHistory',
          'nodeId': parent.currentNode._id
        });
        parent.meshserver.send({
          'action': 'plugin', 'plugin': 'scripttask', 'pluginaction': 'loadVariables',
          'nodeId': parent.currentNode._id
        });
      }
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getExternalDownloadServer' });
    }

    function selectPreviouslySelectedScript() {
      var sel_item = parent.getstore('_scripttask_sel_item', null)
      if (sel_item != null) {
        var s = document.getElementById(sel_item);
        if (s != null) {
          s.classList.toggle('liselected');
          goScript(s);
        }
      }
      if (sel_item != null) parent.meshserver.send({
        'action': 'plugin', 'plugin': 'scripttask', 'pluginaction':
          'loadScriptHistory', 'scriptId': sel_item
      });
    }

    function goRun() {
      var selScript = document.querySelectorAll('.liselected');
      if (selScript.length) {
        var scriptId = selScript[0].getAttribute('x-data-id');
        if (scriptId == selScript[0].getAttribute('x-folder-id')) {
          parent.setDialogMode(2, "Oops!", 1, null, 'Please select a script. A folder is currently selected.');
        }
        else {
          parent.meshserver.send({
            'action': 'plugin', 'plugin': 'scripttask', 'pluginaction': 'runScript',
            'scriptId': scriptId, 'nodes': [parent.currentNode._id], 'currentNodeId': parent.currentNode._id
          });
        }
      } else {
        parent.setDialogMode(2, "Oops!", 1, null, 'No script has been selected to run on the machines.');
      }
    }

    function goEdit() {
      var selScript = document.querySelectorAll('.liselected');
      if (selScript.length && (selScript[0].getAttribute('x-data-id') !=
        selScript[0].getAttribute('x-data-folder'))) {
        var scriptId = selScript[0].getAttribute('x-data-id');
        window.open('/pluginadmin.ashx?pin=scripttask&user=1&edit=1&id=' + scriptId, '_blank');
        window.callback = function (sd) {
          parent.meshserver.send({
            'action': 'plugin', 'plugin': 'scripttask', 'pluginaction': 'editScript',
            'scriptId': sd._id, 'scriptType': sd.type, 'scriptName': sd.name, 'scriptContent': sd.content,
            'currentNodeId': parent.currentNode._id
          });
        };
      } else {
        parent.setDialogMode(2, "Oops!", 1, null, 'No script has been selected to edit.');
      }
    }

    function goAdvancedRun() {
      var cboxes = document.getElementsByName("runOn[]");
      var sel = [];

      cboxes.forEach((n) => {
        if (n.checked) sel.push(n.value);
      });
      if (sel.length == 0) {
        parent.setDialogMode(2, "Oops!", 1, null, 'No machines have been selected.');
        return;
      }
      var selScript = document.getElementById('runNowScriptSelect');
      var scriptId = selScript ? selScript.value : null;
      if (!scriptId || scriptId === '') {
        var selScriptNode = document.querySelectorAll('.liselected');
        if (selScriptNode.length) {
          scriptId = selScriptNode[0].getAttribute('x-data-id');
        }
      }
      if (scriptId && scriptId !== '') {
        parent.meshserver.send({
          'action': 'plugin', 'plugin': 'scripttask', 'pluginaction': 'runScript',
          'scriptId': scriptId, 'nodes': sel, 'currentNodeId': (parent.currentNode ? parent.currentNode._id : '')
        });
        parent.setDialogMode(1, "Success", 1, null, 'Script execution queued for ' + sel.length + ' selected device(s).');
      } else {
        parent.setDialogMode(2, "Oops!", 1, null, 'No script has been selected to run on the machines.');
      }
    }

    function goSchedule() {
      document.getElementById('scripts_endpoints').style.display = 'none';
      document.getElementById('smtp_endpoints').style.display = 'none';
      document.getElementById('compliance_endpoints').style.display = 'none';
      document.getElementById('policy_endpoints').style.display = 'none';
      document.getElementById('schedule_endpoints').style.display = 'block';
      setActiveTab('tabSchedules');
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getSchedules' });
      resizeIframe();
    }

    // Schedule UI Handlers
    var _schedules = [];
    var _scheduleAssignments = [];
    var _currentScheduleId = null;

    function renderSchedules(schedules) {
      _schedules = schedules || [];
      var tbody = document.getElementById('tblSchedulesBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (_schedules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No schedules defined.</td></tr>';
        return;
      }
      _schedules.forEach(function (s) {
        var tr = document.createElement('tr');
        var scriptNames = s.scriptIds.map(id => {
          var sc = scriptTree ? scriptTree.find(x => x._id === id) : null;
          return sc ? sc.name : id;
        }).join(', ');

        var cronStr = s.cronMin + ' ' + s.cronHour + ' ' + s.cronDom + ' ' + s.cronMonth + ' ' + s.cronDow;

        tr.innerHTML = '<td>' + s.name + '</td>' +
          '<td>' + scriptNames + '</td>' +
          '<td>' + cronStr + '</td>' +
          '<td>' +
          '<span class="flink" onclick="viewScheduleAssignments(\x27' + s._id + '\x27, \x27' + s.name.replace(/\x27/g, "\\\x27") + '\x27); ">Assignments</span> | ' +
          '<span class="flink" onclick="showScheduleForm(\x27' + s._id + '\x27);">Edit</span> | ' +
          '<span class="flink" style="color:#f88" onclick="deleteSchedule(\x27' + s._id + '\x27);">Delete</span>' +
          '</td>';
        tbody.appendChild(tr);
      });
    }

    function showScheduleForm(id) {
      document.getElementById('colEditSchedule').classList.remove('hidden');
      document.getElementById('colAssignSchedule').classList.add('hidden');
      _currentScheduleId = id || null;

      // Populate scripts dropdown
      var sel = document.getElementById('sScripts');
      sel.innerHTML = '';
      if (scriptTree) {
        var allSc = scriptTree.filter(function (sc) { return sc.type !== 'folder'; });
        allSc.forEach(function (sc) {
          sel.options.add(new Option(sc.name, sc._id));
        });
      }

      if (id) {
        var s = _schedules.find(x => x._id === id);
        document.getElementById('editScheduleTitle').innerText = 'Edit Schedule';
        document.getElementById('sId').value = s._id;
        document.getElementById('sName').value = s.name;

        Array.from(sel.options).forEach(opt => {
          if (s.scriptIds.includes(opt.value)) opt.selected = true;
        });

        document.getElementById('sCronMin').value = s.cronMin || '*';
        document.getElementById('sCronHour').value = s.cronHour || '*';
        document.getElementById('sCronDom').value = s.cronDom || '*';
        document.getElementById('sCronMonth').value = s.cronMonth || '*';
        document.getElementById('sCronDow').value = s.cronDow || '*';
        document.getElementById('sNotify').checked = s.notifyOnComplete;
        document.getElementById('sNotifyCondition').value = s.notifyCondition || 'any';
        document.getElementById('sNotifyCode').value = s.notifyCode !== undefined ? s.notifyCode : '';
      } else {
        document.getElementById('editScheduleTitle').innerText = 'Create New Schedule';
        document.getElementById('sId').value = '';
        document.getElementById('sName').value = 'New Schedule';
        document.getElementById('sCronMin').value = '*';
        document.getElementById('sCronHour').value = '*';
        document.getElementById('sCronDom').value = '*';
        document.getElementById('sCronMonth').value = '*';
        document.getElementById('sCronDow').value = '*';
        document.getElementById('sNotify').checked = false;
        document.getElementById('sNotifyCondition').value = 'any';
        document.getElementById('sNotifyCode').value = '';
      }
    }

    function cancelEditSchedule() {
      document.getElementById('colEditSchedule').classList.add('hidden');
    }

    function saveSchedule() {
      var sel = document.getElementById('sScripts');
      var scriptIds = Array.from(sel.selectedOptions).map(opt => opt.value);
      if (scriptIds.length === 0) {
        alert("At least one script must be selected!");
        return;
      }

      var s = {
        name: document.getElementById('sName').value,
        scriptIds: scriptIds,
        cronMin: document.getElementById('sCronMin').value,
        cronHour: document.getElementById('sCronHour').value,
        cronDom: document.getElementById('sCronDom').value,
        cronMonth: document.getElementById('sCronMonth').value,
        cronDow: document.getElementById('sCronDow').value,
        notifyOnComplete: document.getElementById('sNotify').checked,
        notifyCondition: document.getElementById('sNotifyCondition').value,
        notifyCode: document.getElementById('sNotifyCode').value ? parseInt(document.getElementById('sNotifyCode').value, 10) : null
      };

      var id = document.getElementById('sId').value;
      if (id) s._id = id;

      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'saveSchedule', schedule: s });
      cancelEditSchedule();
    }

    function deleteSchedule(id) {
      if (confirm('Are you sure you want to delete this schedule?')) {
        parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'deleteSchedule', id: id });
        document.getElementById('colAssignSchedule').classList.add('hidden');
      }
    }

    function viewScheduleAssignments(id, name) {
      _currentScheduleId = id;
      document.getElementById('assignScheduleTitle').innerText = 'Assignments for: ' + name;
      document.getElementById('colAssignSchedule').classList.remove('hidden');
      document.getElementById('colEditSchedule').classList.add('hidden');
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getScheduleAssignments', scheduleId: id });
    }

    function renderScheduleAssignments(assigns) {
      _scheduleAssignments = assigns || [];
      var tbody = document.getElementById('tblScheduleAssignmentsBody');
      if (!tbody) {
        // If we forgot it in UI html, inject under colAssignSchedule dynamically
        var targetDiv = document.querySelector('#colAssignSchedule .panel div[style*="margin-top: 15px"]');
        var tbl = document.createElement('table');
        tbl.style.width = '100%';
        tbl.style.marginTop = '15px';
        tbl.style.borderCollapse = 'collapse';
        tbl.innerHTML = '<thead><tr><th style="background:#f0f0f0;padding:5px;border:1px solid #ccc;">Target Type</th><th style="background:#f0f0f0;padding:5px;border:1px solid #ccc;">Target Name</th><th style="background:#f0f0f0;padding:5px;border:1px solid #ccc;">Actions</th></tr></thead><tbody id="tblScheduleAssignmentsBody"></tbody>';
        document.querySelector('#colAssignSchedule .panel').insertBefore(tbl, targetDiv);
        tbody = document.getElementById('tblScheduleAssignmentsBody');
      }
      tbody.innerHTML = '';
      if (_scheduleAssignments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No assignments. Schedule is inactive.</td></tr>';
        return;
      }
      _scheduleAssignments.forEach(function (a) {
        var tr = document.createElement('tr');
        var targetName = a.targetId;
        if (a.targetType === 'node' && parent.nodes) {
          var n = parent.nodes.find(x => x._id === a.targetId);
          if (n) targetName = n.name;
        } else if (a.targetType === 'mesh' && parent.meshes) {
          var m = parent.meshes[a.targetId];
          if (m) targetName = m.name;
        }
        tr.innerHTML = '<td>' + a.targetType + '</td><td>' + targetName + '</td><td><span class="flink" style="color:#f88" onclick="deleteScheduleAssignment(\x27' + a._id + '\x27);">Remove</span></td>';
        tbody.appendChild(tr);
      });
    }

    function showScheduleFormAssign() {
      document.getElementById('colAssignSchedule').classList.remove('hidden');
      updateScheduleTargetList();
    }

    function updateScheduleTargetList() {
      var type = document.getElementById('saTargetType').value;
      var sel = document.getElementById('saTargetId');
      sel.innerHTML = '';
      if (type === 'node') {
        var nodes = parent.nodes || [];
        nodes.forEach(function (n) { if (n.mtype === 2) sel.options.add(new Option(n.name, n._id)); });
      } else if (type === 'mesh') {
        var meshes = parent.meshes || {};
        for (var key in meshes) { if (meshes[key].mtype === 2) sel.options.add(new Option(meshes[key].name, key)); }
      } else if (type === 'tag') {
        sel.options.add(new Option("Please enter the precise Tag string here ->", ""));
        var tagName = prompt("Enter the exact name of the Device Tag:");
        if (tagName) {
          sel.options.add(new Option("Tag: " + tagName, tagName)); sel.value = tagName;
        }
      }
    }

    function saveScheduleAssignment() {
      var typ = document.getElementById('saTargetType').value;
      var tid = document.getElementById('saTargetId').value;
      if (!tid) return;
      var a = { scheduleId: _currentScheduleId, targetType: typ, targetId: tid };
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'saveScheduleAssignment', assignment: a });
    }

    function deleteScheduleAssignment(id) {
      if (confirm('Remove this assignment?')) {
        parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'deleteScheduleAssignment', id: id });
      }
    }

    function cancelAssignSchedule() {
      document.getElementById('colAssignSchedule').classList.add('hidden');
    }

    function goPolicy() {
      document.getElementById('scripts_endpoints').style.display = 'none';
      document.getElementById('schedule_endpoints').style.display = 'none';
      document.getElementById('smtp_endpoints').style.display = 'none';
      document.getElementById('compliance_endpoints').style.display = 'none';
      document.getElementById('policy_endpoints').style.display = 'block';
      setActiveTab('tabPolicies');
      doOnLoadPolicy();
      resizeIframe();
    }

    function goEmailNotification() {
      // Hide other sections, show Email
      document.getElementById('scriptContainer').style.display = 'none';
      document.getElementById('infoContainer').style.display = 'none';
      document.getElementById('schedule_endpoints').style.display = 'none';
      document.getElementById('policy_endpoints').style.display = 'none';
      document.getElementById('compliance_endpoints').style.display = 'none';
      document.getElementById('email_notifications').style.display = 'block';
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getSmtpConfig' });
    }

    function promptExtDownloadServer() {
      var currentVal = document.getElementById('extDownloadUrlText').innerText;
      if (currentVal.indexOf('No External') !== -1) currentVal = 'https://';
      var newVal = prompt('Enter the External Download Server URL:', currentVal);
      if (newVal !== null) {
        parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'saveExternalDownloadServer', config: { url: newVal.trim() } });
      }
    }
    function goSmtp() {
      document.getElementById('scripts_endpoints').style.display = 'none';
      document.getElementById('schedule_endpoints').style.display = 'none';
      document.getElementById('policy_endpoints').style.display = 'none';
      document.getElementById('compliance_endpoints').style.display = 'none';
      document.getElementById('smtp_endpoints').style.display = 'block';
      setActiveTab('tabSmtp');
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getSmtpConfig' });
      resizeIframe();
    }

    function goCompliance() {
      document.getElementById('scripts_endpoints').style.display = 'none';
      document.getElementById('schedule_endpoints').style.display = 'none';
      document.getElementById('policy_endpoints').style.display = 'none';
      document.getElementById('smtp_endpoints').style.display = 'none';
      document.getElementById('compliance_endpoints').style.display = 'block';
      setActiveTab('tabCompliance');
      var tbody = document.getElementById('cev-overview-body');
      if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="color:#999;font-style:italic;">Loading...</td></tr>';
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getComplianceOverview' });
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getRetentionRules' });
      resizeIframe();
    }

    function showComplianceOverview() {
      document.getElementById('cev-overview').style.display = 'block';
      document.getElementById('cev-detail').style.display = 'none';
    }

    var complianceNodeMap = {}; // nodeId -> name from parent.nodes

    function getNodeName(nodeId) {
      if (parent && parent.nodes) {
        var n = parent.nodes.find(function (x) { return x._id === nodeId; });
        if (n) return n.name || nodeId.slice(-8);
      }
      return nodeId.slice(-8);
    }

    function getNodeDesc(nodeId) {
      if (parent && parent.nodes) {
        var n = parent.nodes.find(function (x) { return x._id === nodeId; });
        if (n && n.desc) return n.desc;
      }
      return '';
    }

    function getNodeLastUser(nodeId) {
      if (parent && parent.nodes) {
        var n = parent.nodes.find(function (x) { return x._id === nodeId; });
        if (n && n.users && n.users.length > 0) return n.users[0];
      }
      return '';
    }

    function getNodeLastIp(nodeId) {
      if (parent && parent.nodes) {
        var n = parent.nodes.find(function (x) { return x._id === nodeId; });
        if (n) {
          var raw = '';
          if (n.pconn && n.pconn.remoteIp) raw = n.pconn.remoteIp;
          else if (n.ip) raw = n.ip;
          else if (n.address) raw = n.address;
          if (raw && typeof raw === 'string') {
            var s = raw.replace(/^::ffff:/, '');
            if (s.includes('[') && s.includes(']')) {
              return s.substring(s.indexOf('[') + 1, s.indexOf(']'));
            }
            if (s.split(':').length === 2) {
              return s.split(':')[0];
            }
            return s;
          }
        }
      }
      return '';
    }

    // Helper mapping for common IANA timezones to short codes to satisfy user format request
    var _tzAcronyms = {
      "America/Los_Angeles": "PST/PDT", "America/Denver": "MST/MDT",
      "America/Chicago": "CST/CDT", "America/New_York": "EST/EDT",
      "Europe/London": "GMT/BST", "Europe/Paris": "CET/CEST",
      "Europe/Berlin": "CET/CEST", "Asia/Tokyo": "JST",
      "Australia/Sydney": "AEST/AEDT", "Asia/Shanghai": "CST",
      "Asia/Kolkata": "IST"
    };

    function getTzLabel() {
      try {
        var tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        return _tzAcronyms[tz] || tz;
      } catch (e) {
        return 'Local Time';
      }
    }

    function fmtTs(ts) {
      if (!ts) return '-';
      var d = new Date(ts * 1000);
      return d.toLocaleString() + ' (' + getTzLabel() + ')';
    }

    var complianceOverviewData = [];

    function renderComplianceOverview(rows) {
      var tbody = document.getElementById('cev-overview-body');
      if (!tbody) return;
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="color:#999;font-style:italic;">No compliance data yet. Data is collected when agents connect.</td></tr>';
        return;
      }
      var html = '';
      rows.forEach(function (row) {
        var name = getNodeName(row.nodeId);
        var dispIp = row.lastIp || getNodeLastIp(row.nodeId);
        var ipLink = dispIp
          ? '<a href="https://iplocation.com/?ip=' + encodeURIComponent(dispIp) + '" target="_blank" rel="noopener" style="color:#0066cc;">' + dispIp + '</a>'
          : '-';
        var ipCell = ipLink + (row.lastIpTimestamp ? '<br><span style="color:#999;font-size:11px;">' + fmtTs(row.lastIpTimestamp) + '</span>' : '');

        var desc = getNodeDesc(row.nodeId);
        var dispUser = row.lastUser || getNodeLastUser(row.nodeId) || '';
        html += '<tr data-name="' + name.toLowerCase() + '" data-user="' + dispUser.toLowerCase() + '" data-desc="' + desc.toLowerCase() + '">';
        var deviceNodeStr = (row.nodeId && row.nodeId.split('/').length > 2) ? row.nodeId.split('/')[2] : '';
        var deviceLink = '<a href="?gotonode=' + deviceNodeStr + '" target="_top" onclick="if(typeof parent !== \'undefined\' && typeof parent.gotoDevice === \'function\') { parent.gotoDevice(\'' + row.nodeId + '\', 10); return false; }" style="color:#0066cc;text-decoration:none;" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">' + name + '</a>';
        html += '<td>' + deviceLink + '</td>';
        html += '<td>' + (desc || '<span style="color:#bbb;font-style:italic;">-</span>') + '</td>';
        html += '<td>' + (dispUser || '<span style="color:#bbb;font-style:italic;">-</span>') + '</td>';
        html += '<td>' + ipCell + '</td>';
        html += '<td><span class="flink" onclick="loadDeviceDetail(\'' + row.nodeId + '\', \'' + name.replace(/'/g, "'") + '\')">Details &rsaquo;</span></td>';
        html += '</tr>';
      });
      tbody.innerHTML = html;
    }

    parent.pluginHandler.scripttask.complianceOverview = function (message) {
      complianceOverviewData = message.event.overview || [];
      if (parent && parent.nodes) {
        parent.nodes.forEach(function (n) {
          if (n.icon && !complianceOverviewData.find(function (c) { return c.nodeId === n._id; })) {
            complianceOverviewData.push({ nodeId: n._id });
          }
        });
      }
      complianceOverviewData.sort(function (a, b) {
        var av = getNodeName(a.nodeId).toLowerCase(), bv = getNodeName(b.nodeId).toLowerCase();
        return av < bv ? -1 : av > bv ? 1 : 0;
      });
      renderComplianceOverview(complianceOverviewData);
    };

    function complianceSearchCurrent() {
      if (parent && parent.currentNode && parent.currentNode.name) {
        var s = document.getElementById('cev-search');
        if (s) {
          s.value = parent.currentNode.name;
          filterComplianceOverview();
        }
      }
    }

    function filterComplianceOverview() {
      var q = document.getElementById('cev-search').value.toLowerCase();
      var rows = document.querySelectorAll('#cev-overview-body tr');
      rows.forEach(function (r) {
        var name = (r.getAttribute('data-name') || '');
        var user = (r.getAttribute('data-user') || '');
        var desc = (r.getAttribute('data-desc') || '');
        r.style.display = (!q || name.includes(q) || user.includes(q) || desc.includes(q)) ? '' : 'none';
      });
    }

    function sortComplianceOverview(key) {
      if (complianceSortKey === key) complianceSortAsc = !complianceSortAsc;
      else { complianceSortKey = key; complianceSortAsc = true; }
      complianceOverviewData.sort(function (a, b) {
        var av, bv;
        if (key === 'user') { av = (a.lastUser || getNodeLastUser(a.nodeId)); bv = (b.lastUser || getNodeLastUser(b.nodeId)); }
        else if (key === 'desc') { av = getNodeDesc(a.nodeId); bv = getNodeDesc(b.nodeId); }
        else { av = getNodeName(a.nodeId); bv = getNodeName(b.nodeId); }
        av = av.toLowerCase(); bv = bv.toLowerCase();

        var cmp = av < bv ? -1 : av > bv ? 1 : 0;
        return complianceSortAsc ? cmp : -cmp;
      });
      renderComplianceOverview(complianceOverviewData);
    }

    parent.pluginHandler.scripttask.deviceEvents = function (message) {
      var events = message.event.events || [];
      var ipTbl = document.getElementById('cev-ip-tbl');
      var userTbl = document.getElementById('cev-user-tbl');
      if (!ipTbl) return;
      var ipHtml = '', userHtml = '';
      events.forEach(function (ev) {
        if (ev.eventType === 'ipSeen') {
          var ipVal = ev.data.ip;
          var ipLnk = ipVal ? '<a href="https://iplocation.com/?ip=' + encodeURIComponent(ipVal) + '" target="_blank" rel="noopener" style="color:#0066cc;">' + ipVal + '</a>' : '-';
          ipHtml += '<tr><td>' + fmtTs(ev.timestamp) + '</td><td>' + ipLnk + '</td></tr>';
        } else if (ev.eventType === 'lastUser') {
          userHtml += '<tr><td>' + fmtTs(ev.timestamp) + '</td><td>' + (ev.data.user || '-') + '</td></tr>';
        }
      });

      if (!ipHtml && message.event.nodeId) {
        var currIp = getNodeLastIp(message.event.nodeId);
        if (currIp) {
          var ipLnk = '<a href="https://iplocation.com/?ip=' + encodeURIComponent(currIp) + '" target="_blank" rel="noopener" style="color:#0066cc;">' + currIp + '</a>';
          ipHtml = '<tr><td><i style="color:#666;">Current</i></td><td>' + ipLnk + '</td></tr>';
        }
      }

      if (!userHtml && message.event.nodeId) {
        var currUsr = getNodeLastUser(message.event.nodeId);
        if (currUsr) {
          userHtml = '<tr><td><i style="color:#666;">Current</i></td><td>' + currUsr + '</td></tr>';
        }
      }

      ipTbl.innerHTML = ipHtml || '<tr><td colspan="2" style="color:#999;">No records</td></tr>';
      if (userTbl) userTbl.innerHTML = userHtml || '<tr><td colspan="2" style="color:#999;">No records</td></tr>';
    };

    function loadDeviceDetail(nodeId, name) {
      document.getElementById('cev-overview').style.display = 'none';
      document.getElementById('cev-detail').style.display = 'block';
      document.getElementById('cev-detail-name').textContent = name;
      document.getElementById('cev-ip-tbl').innerHTML = '<tr><td colspan="2" style="color:#999;">Loading...</td></tr>';
      var ut = document.getElementById('cev-user-tbl');
      if (ut) ut.innerHTML = '<tr><td colspan="2" style="color:#999;">Loading...</td></tr>';
      var pt = document.getElementById('cev-power-tbl');
      if (pt) pt.innerHTML = '<tr><td colspan="2" style="color:#999;">Loading...</td></tr>';

      var pDays = 180;
      if (typeof retentionRulesCache !== 'undefined') {
        var pGlobal = retentionRulesCache.find(function (r) { return r.eventType === 'powerHistory' && r.targetType === 'global'; });
        if (pGlobal && pGlobal.days) pDays = pGlobal.days;
      }

      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getDeviceEvents', nodeId: nodeId });
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getPowerHistory', nodeId: nodeId, days: pDays });
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'getPowerAlertConfig', nodeId: nodeId });
      // Reset alert checkbox while loading
      var alertChk = document.getElementById('cev-pwr-alert-chk');
      if (alertChk) alertChk.checked = false;
      var alertStatus = document.getElementById('cev-pwr-alert-status');
      if (alertStatus) alertStatus.textContent = '';
      resizeIframe();
    }

    // ---- Power History pagination state ----
    var _pwrEvents = [];
    var _pwrPage = 0;
    var _pwrPageSize = 50;
    var _pwrCurrentNodeId = null;

    function pwrStateColor(state) {
      if (state === 1) return '#28a745';
      if (state === 2 || state === 3) return '#9370db';
      if (state === 4) return '#e6a800';
      if (state === 0) return '#aaa';
      return '#ccc';
    }

    function fmtDuration(secs) {
      if (!secs || secs < 0) return '-';
      var d = Math.floor(secs / 86400);
      var h = Math.floor((secs % 86400) / 3600);
      var m = Math.floor((secs % 3600) / 60);
      var parts = [];
      if (d) parts.push(d + 'd');
      if (h) parts.push(h + 'h');
      if (m) parts.push(m + 'm');
      if (!parts.length) parts.push('< 1m');
      return parts.join(' ');
    }

    function renderPwrPage() {
      var pt = document.getElementById('cev-power-tbl');
      if (!pt) return;
      var total = _pwrEvents.length;
      var start = _pwrPage * _pwrPageSize;
      var end = Math.min(start + _pwrPageSize, total);
      var pageEvents = _pwrEvents.slice(start, end);

      // Newest-first for display
      var html = '';
      for (var i = pageEvents.length - 1; i >= 0; i--) {
        var ev = pageEvents[i];
        var badge = '<span style="display:inline-block; padding:1px 7px; border-radius:3px; font-size:11px; font-weight:bold; color:#fff; background:' + pwrStateColor(ev.state) + ';">' + (ev.stateLabel || 'State ' + ev.state) + '</span>';
        var dur = (i === pageEvents.length - 1 && end === total) ? fmtDuration(ev.duration) + ' <span style="color:#999;font-size:10px;">(ongoing)</span>' : fmtDuration(ev.duration);
        html += '<tr><td style="white-space:nowrap;">' + fmtTs(ev.time) + '</td><td>' + badge + '</td><td style="white-space:nowrap;color:#555;">' + dur + '</td></tr>';
      }
      if (!html) html = '<tr><td colspan="3" style="color:#999;">No power state records found.</td></tr>';
      pt.innerHTML = html;

      // Page info
      var totalPages = Math.max(1, Math.ceil(total / _pwrPageSize));
      var pi = document.getElementById('cev-pwr-pageinfo');
      if (pi) pi.textContent = 'Page ' + (_pwrPage + 1) + ' of ' + totalPages;
      var pc = document.getElementById('cev-pwr-count');
      if (pc) pc.textContent = total + ' transition' + (total !== 1 ? 's' : '');
      var prev = document.getElementById('cev-pwr-prev');
      var next = document.getElementById('cev-pwr-next');
      if (prev) prev.disabled = _pwrPage === 0;
      if (next) next.disabled = _pwrPage >= totalPages - 1;
    }

    function pwrPageNav(delta) {
      var totalPages = Math.max(1, Math.ceil(_pwrEvents.length / _pwrPageSize));
      _pwrPage = Math.max(0, Math.min(_pwrPage + delta, totalPages - 1));
      renderPwrPage();
    }

    function downloadPowerHistoryCSV() {
      var devName = (document.getElementById('cev-detail-name') || {}).innerText || 'Device';
      var lines = [
        '"Power History for ' + devName.replace(/"/g, '""') + '"',
        '"Legend: On=Powered On, Sleep=Sleeping/Hibernating, Soft-Off=Soft Power Off, Off=Powered Off"',
        '',
        '"State Entered","Power State","Duration"'
      ];
      // Export newest-first (full dataset, all pages)
      var sorted = _pwrEvents.slice().reverse();
      sorted.forEach(function (ev, i) {
        var dur = fmtDuration(ev.duration);
        if (i === 0) dur += ' (ongoing)';
        lines.push('"' + fmtTs(ev.time).replace(/"/g, '""') + '","' + (ev.stateLabel || '').replace(/"/g, '""') + '","' + dur + '"');
      });
      var blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = devName.replace(/[^a-zA-Z0-9_-]/g, '_') + '_power_history.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function savePwrAlertConfig() {
      var chk = document.getElementById('cev-pwr-alert-chk');
      if (!chk || !_pwrCurrentNodeId) return;
      var alertStatus = document.getElementById('cev-pwr-alert-status');
      if (alertStatus) alertStatus.textContent = 'Saving...';
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask',
        pluginaction: 'savePowerAlertConfig',
        nodeId: _pwrCurrentNodeId,
        alertOnStateChange: chk.checked
      });
    }

    parent.pluginHandler.scripttask.powerAlertConfigData = function (message) {
      if (!message.event || !message.event.nodeId) return;
      var cfg = message.event.config || {};
      var chk = document.getElementById('cev-pwr-alert-chk');
      if (chk) chk.checked = !!(cfg.alertOnStateChange);
      var alertStatus = document.getElementById('cev-pwr-alert-status');
      if (alertStatus) alertStatus.textContent = cfg.alertOnStateChange ? '\u2714 Alerts on' : '';
    };

    parent.pluginHandler.scripttask.powerHistory = function (message) {
      if (!message.event || !message.event.nodeId) return;
      var nodeId = message.event.nodeId;
      _pwrEvents = message.event.events || [];
      _pwrPage = 0;
      _pwrCurrentNodeId = nodeId;

      if (document.getElementById('cev-detail') && document.getElementById('cev-detail').style.display !== 'block') return;

      // Render paginated table
      renderPwrPage();
    };

    function downloadSpecificTableCSV(tableId, title) {
      function getTableCSV(tId, tTitle) {
        var tbl = document.getElementById(tId);
        if (!tbl) return '';
        var rows = tbl.querySelectorAll('tr');
        var csv = tTitle + '\n';
        rows.forEach(function (r) {
          var cells = r.querySelectorAll('td, th');
          var rowData = [];
          cells.forEach(function (c) {
            var txt = c.innerText.replace(/"/g, '""');
            rowData.push('"' + txt + '"');
          });
          csv += rowData.join(',') + '\n';
        });
        return csv;
      }
      var devName = document.getElementById('cev-detail-name').innerText;
      var fileData = "Device Name: " + devName + "\n\n" + getTableCSV(tableId, title);

      var blob = new Blob([fileData], { type: 'text/csv' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      var cleanTitle = title.replace(/\\W+/g, '');
      a.setAttribute('download', devName.replace(/\\W+/g, '_') + '_' + cleanTitle + '.csv');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    var retentionRulesCache = [];

    parent.pluginHandler.scripttask.retentionRules = function (message) {
      retentionRulesCache = message.event.rules || [];
      // Populate default inputs
      var typeToInputId = { ipSeen: 'ret-ip-days', lastUser: 'ret-user-days', bootTime: 'ret-boot-days', powerHistory: 'ret-power-days' };
      retentionRulesCache.forEach(function (r) {
        if (r.targetType === 'global' && typeToInputId[r.eventType]) {
          var inp = document.getElementById(typeToInputId[r.eventType]);
          if (inp) inp.value = r.days;
        }
      });
      // Render scoped overrides
      var tbody = document.getElementById('cev-retention-overrides');
      if (!tbody) return;
      var overrides = retentionRulesCache.filter(function (r) { return r.targetType !== 'global'; });
      if (!overrides.length) { tbody.innerHTML = '<tr><td colspan="5" style="color:#999;">No overrides</td></tr>'; return; }
      var html = '';
      overrides.forEach(function (r) {
        html += '<tr>';
        html += '<td>' + r.eventType + '</td>';
        html += '<td>' + (r.targetType || '') + '</td>';
        html += '<td>' + (r.targetId || '') + '</td>';
        html += '<td>' + r.days + '</td>';
        html += '<td><span class="flink" style="color:#c00;" onclick="deleteRetentionRule(\'' + r._id + '\');">Remove</span></td>';
        html += '</tr>';
      });
      tbody.innerHTML = html;
    };

    function saveDefaultRetention(eventType) {
      var idMap = { ipSeen: 'ret-ip-days', lastUser: 'ret-user-days', powerHistory: 'ret-power-days' };
      var days = parseInt(document.getElementById(idMap[eventType]).value, 10);
      if (isNaN(days) || days < 1) { alert('Please enter a valid number of days.'); return; }
      var existing = retentionRulesCache.find(function (r) { return r.targetType === 'global' && r.eventType === eventType; });
      var rule = existing ? Object.assign({}, existing, { days: days }) : { eventType: eventType, targetType: 'global', days: days };
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'saveRetentionRule', rule: rule });
    }

    function deleteRetentionRule(id) {
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'deleteRetentionRule', id: id });
    }

    function addRetentionOverride() {
      var tbody = document.getElementById('cev-retention-overrides');
      var row = document.createElement('tr');
      row.innerHTML = '<td><select class="ort-type"><option value="ipSeen">IP Seen</option><option value="lastUser">Last User</option><option value="powerHistory">Power History</option></select></td>' +
        '<td><select class="ort-scope"><option value="node">Node</option><option value="mesh">Mesh</option><option value="tag">Tag</option></select></td>' +
        '<td><input type="text" class="ort-target" style="width:120px;" placeholder="ID or name"></td>' +
        '<td><input type="number" class="ort-days" min="1" value="90" style="width:60px;"></td>' +
        '<td><button style="background:#007bff;color:#fff;" onclick="saveNewOverride(this);">Save</button></td>';
      tbody.appendChild(row);
    }

    function saveNewOverride(btn) {
      var row = btn.closest('tr');
      var eventType = row.querySelector('.ort-type').value;
      var targetType = row.querySelector('.ort-scope').value;
      var targetId = row.querySelector('.ort-target').value.trim();
      var days = parseInt(row.querySelector('.ort-days').value, 10);
      if (!targetId) { alert('Please enter a target ID or name.'); return; }
      if (isNaN(days) || days < 1) { alert('Please enter a valid number of days.'); return; }
      parent.meshserver.send({ action: 'plugin', plugin: 'scripttask', pluginaction: 'saveRetentionRule', rule: { eventType: eventType, targetType: targetType, targetId: targetId, days: days } });
    }


    function prepHistory(nh) {
      var
        nowTime = Math.floor(new Date() / 1000); var d = new Date(0); d.setUTCSeconds(nh.latestTime);
      nh.timeStr = d.toLocaleString(); if (nh.errorVal != null) { nh.returnTxt = nh.errorVal; } else {
        nh.returnTxt = nh.returnVal;
      } nh.statusTxt = 'Queued'; if (nh.dispatchTime != null)
        nh.statusTxt = 'Running'; if (nh.errorVal != null) nh.statusTxt = 'Error'; if (nh.returnVal != null)
        nh.statusTxt = 'Completed'; if (nh.dontQueueUntil > nowTime) nh.statusTxt = 'Scheduled';
      if (nh.returnTxt == null) nh.returnTxt = '&nbsp;';
      if (nh.statusTxt == 'Completed') {
        nh.statusTxt = '<span title="Completed ' + secondsToHms((nh.completeTime - nh.dispatchTime)) + '">' +
          nh.statusTxt + '</span>';
      }
      if (isJsonString(nh.returnTxt)) {
        try {
          nh.returnObj = JSON.parse(nh.returnTxt);
          nh.returnTxt = 'Object: ';
          nh.returnTxt += '' + JSON.stringify(nh.returnObj, null, 2);
          nh.returnTxt = nh.returnTxt.replace(/\n\s*\n/g, '\n');
          nh.returnTxt = nh.returnTxt.replace(/(?:\r\n|\r|\n)/g, '<br />');
        } catch (e) { }
      } else {
        if (typeof nh.returnTxt == 'string') {
          nh.returnTxt = nh.returnTxt.replace(/\n\s*\n/g, '\n');
          nh.returnTxt = nh.returnTxt.replace(/(?:\r\n|\r|\n)/g, '<br />');
        }
      }
      return nh;
    }
    parent.pluginHandler.scripttask.loadVariables = function (message) {
      if (message.event.vars.length) {
        var vars = message.event.vars;
        vars.forEach(function (vd) {
          switch (vd.scope) {
            case 'global':
              vd.scopeTargetTxt = vd.scopeTargetHtml = 'N/A';
              break;
            case 'script':
              var s = scriptTree.filter(obj => { return obj._id === vd.scopeTarget })[0]
              vd.scopeTargetHtml = '<span title="' + s.path + '">' + s.name + '</span>';
              vd.scopeTargetTxt = s.name;
              break;
            case 'mesh':
              vd.scopeTargetTxt = vd.scopeTargetHtml = parent.meshes[vd.scopeTarget].name;
              break;
            case 'node':
              var n = parent.nodes.filter(obj => { return obj._id === vd.scopeTarget })[0]
              vd.scopeTargetHtml = '<span title="' + n.meshnamel + '">' + n.name + '</span>';
              vd.scopeTargetTxt = n.name;
              break;
            default:
              vd.scopeTargetTxt = vd.scopeTargetHtml = 'N/A';
              break;
          }
          vd.scopeTxt = varScopes[vd.scope];
        })
        var ordering = { 'global': 0, 'script': 1, 'mesh': 2, 'node': 3 }
        vars.sort((a, b) => {
          return (ordering[a.scope] - ordering[b.scope])
            || a.name.localeCompare(b.name)
            || a.scopeTargetTxt.localeCompare(b.scopeTargetTxt);
        });
        variables = vars;
        parseVariables();
      }
    }
    parent.pluginHandler.scripttask.scheduleData = function (message) {
      if (message.event.error) alert("Schedule Data Error: " + message.event.error);
      renderSchedules(message.event.schedules);
      _scheduleAssignments = message.event.assignments || [];
      if (_currentScheduleId && !document.getElementById('colAssignSchedule').classList.contains('hidden')) {
        renderScheduleAssignments(_scheduleAssignments.filter(a => a.scheduleId === _currentScheduleId));
      }
    }
    parent.pluginHandler.scripttask.scheduleAssignmentData = function (message) {
      renderScheduleAssignments(message.event.assignments);
    }
    parent.pluginHandler.scripttask.policyData = function (message) {
      loadPolicyData(message.event.policies, message.event.assignments, message.event.error);
    }
    parent.pluginHandler.scripttask.smtpData = function (message) {
      loadSmtpData(message.event.config, message.event.error);
    }
    parent.pluginHandler.scripttask.externalDownloadServerData = function (message) {
      var el = document.getElementById('extDownloadUrlText');
      if (el) {
        if (message.event.config && message.event.config.url) {
          el.innerHTML = '<a href="' + message.event.config.url + '" target="_blank">' + message.event.config.url + '</a>';
        } else {
          el.innerHTML = '<i>No External Download URL configured.</i>';
        }
      }
    }
    function parseVariables() {
      var vTbl = document.getElementById('varTbl');
      var rows = vTbl.querySelectorAll('.stVRow');

      if (rows.length) {
        rows.forEach(function (r) {
          r.parentNode.removeChild(r);
        });
      }
      var scriptEl = document.querySelectorAll('.liselected');
      if (scriptEl.length != 1) return;
      var el = scriptEl[0];
      scopeTargetScriptId = el.getAttribute('x-data-id');
      variables.forEach(function (vd) {
        if (vd.scope == 'script' && vd.scopeTarget != scopeTargetScriptId) return;
        if (vd.scope == 'mesh' && vd.scopeTarget != parent.currentNode.meshid) return;
        if (vd.scope == 'node' && vd.scopeTarget != parent.currentNode._id) return;
        let actionHtml = `<span class="flink" onclick="editVar(this);">Edit</span> <span class="flink"
          onclick = "delVar(this);" > Delete</span > `;
        let tpl = '<td>' + vd.name + '</td> \
                    <td>' + vd.value + '</td> \
                    <td>' + vd.scopeTxt + '</td> \
                    <td>' + vd.scopeTargetHtml + '</td> \
                    <td>' + actionHtml + '</td>';
        let tr = vTbl.insertRow(-1);
        tr.innerHTML = tpl;
        tr.classList.add('stVRow');
        tr.setAttribute('x-data-id', vd._id);
      })
    }
    parent.pluginHandler.scripttask.loadSchedule = function (message) {
      // cache script names
      var nNames = {}, sNames = {};
      parent.nodes.forEach(function (n) {
        nNames[n._id] = n.name;
      });
      scriptTree.forEach(function (s) {
        if (s.type == 'script') sNames[s._id] = s.name;
      });
      if (message.event.nodeSchedule != null && message.event.nodeId == parent.currentNode._id) {
        var nTbl = document.getElementById('nSchTbl');
        var rows = nTbl.querySelectorAll('.stNSRow');
        if (rows.length) {
          rows.forEach(function (r) {
            r.parentNode.removeChild(r);
          });
        }
        if (message.event.nodeSchedule.length) {
          message.event.nodeSchedule.forEach(function (nh) {
            nh = prepSchedule(nh);
            let tpl = '<td>' + sNames[nh.scriptId] + '</td> \
                    <td>' + nh.scheduledBy + '</td> \
                    <td>' + nh.everyTxt + '</td> \
                    <td>' + nh.startedTxt + '</td> \
                    <td>' + nh.endingTxt + '</td> \
                    <td>' + nh.lastRunTxt + '</td> \
                    <td>' + nh.nextRunTxt + '</td> \
                    <td>' + nh.actionTxt + '</td>';
            let tr = nTbl.insertRow(-1);
            tr.innerHTML = tpl;
            tr.classList.add('stNSRow');
            tr.setAttribute('x-data-id', nh._id);
          });
        }
      }
      var currentScript = document.getElementById('scriptHistory');
      var currentScriptId = currentScript.getAttribute('x-data-id');
      if (message.event.scriptSchedule != null && message.event.scriptId == currentScriptId) {
        var sTbl = document.getElementById('sSchTbl');
        var rows = sTbl.querySelectorAll('.stSSRow');
        if (rows.length) {
          rows.forEach(function (r) {
            r.parentNode.removeChild(r);
          });
        }
        if (message.event.scriptSchedule.length) {
          message.event.scriptSchedule.forEach(function (nh) {
            nh = prepSchedule(nh);
            let tpl = '<td>' + nNames[nh.node] + '</td> \
                    <td>' + nh.scheduledBy + '</td> \
                    <td>' + nh.everyTxt + '</td> \
                    <td>' + nh.startedTxt + '</td> \
                    <td>' + nh.endingTxt + '</td> \
                    <td>' + nh.lastRunTxt + '</td> \
                    <td>' + nh.nextRunTxt + '</td> \
                    <td>' + nh.actionTxt + '</td>';
            let tr = sTbl.insertRow(-1);
            tr.innerHTML = tpl;
            tr.classList.add('stSSRow');
            tr.setAttribute('x-data-id', nh._id);
          });
        }
      }
      resizeIframe();
    }
    function prepSchedule(nh) {
      nh.everyTxt = nh.interval + ' ';
      switch (nh.recur) {
        case 'once':
          nh.everyTxt = 'Once';
          break;
        case 'minutes':
          nh.everyTxt += 'minute';
          break;
        case 'hourly':
          nh.everyTxt += 'hour';
          break;
        case 'daily':
          nh.everyTxt += 'day';
          break;
        case 'weekly':
          nh.everyTxt += 'week';
          break;
        case 'monthly':
          nh.everyTxt += 'month';
          break;
      }
      if (nh.interval > 1) nh.everyTxt += 's';

      if (nh.recur == 'weekly') {
        nh.daysOfWeek = nh.daysOfWeek.map(el => Number(el));
        nh.everyTxt += ' (';
        nh.daysOfWeek.forEach(function (num) {
          switch (num) {
            case 0: nh.everyTxt += 'S'; break;
            case 1: nh.everyTxt += 'M'; break;
            case 2: nh.everyTxt += 'T'; break;
            case 3: nh.everyTxt += 'W'; break;
            case 4: nh.everyTxt += 'R'; break;
            case 5: nh.everyTxt += 'F'; break;
            case 6: nh.everyTxt += 'S'; break;
          }
        });
        nh.everyTxt += ')';
      }

      var d = new Date(0); d.setUTCSeconds(nh.startAt);
      nh.startedTxt = d.toLocaleString();
      d = new Date(0); d.setUTCSeconds(nh.endAt);
      nh.endingTxt = d.toLocaleString();
      if (nh.endAt == null) nh.endingTxt = 'Never';
      if (nh.recur == 'once') nh.endingTxt = 'After first run';
      d = new Date(0); d.setUTCSeconds(nh.lastRun);
      nh.lastRunTxt = d.toLocaleString();
      if (nh.lastRun == null) nh.lastRunTxt = 'Never';
      d = new Date(0); d.setUTCSeconds(nh.nextRun);
      nh.nextRunTxt = d.toLocaleString();
      if (nh.nextRun == null) nh.nextRunTxt = 'Never';
      if (nh.nextRun < nh.lastRun) nh.nextRunTxt = 'Running now';
      nh.actionTxt = '<span class="delSched" onclick="deleteSchedule(this);">Delete</span>'; return nh;
    }
    function secondsToHms(d) {
      d = Number(d); if (d == 0) return "immediately"; var h = Math.floor(d /
        3600); var m = Math.floor(d % 3600 / 60); var s = Math.floor(d % 3600 % 60); var hDisplay = h > 0 ? h +
          (h == 1 ? " hour, " : " hours, ") : "";
      var mDisplay = m > 0 ? m + (m == 1 ? " minute, " : " minutes, ") : "";
      var sDisplay = s > 0 ? s + (s == 1 ? " second" : " seconds") : "";
      return "in " + hDisplay + mDisplay + sDisplay;
    }
    function isJsonString(str) {
      try {
        JSON.parse(str);
      } catch (e) {
        return false;
      }
      return true;
    }
    function newVarEx() {
      var name = parent.document.getElementById('stvarname').value;
      var scope = parent.document.getElementById('stvarscope').value;
      var value = parent.document.getElementById('stvarvalue').value;
      var scopeTarget = null;
      if (scope == 'script') {
        var scriptEl = document.querySelectorAll('.liselected');
        if (scriptEl.length != 1) return;
        var el = scriptEl[0];
        scopeTarget = el.getAttribute('x-data-id');
      } else if (scope == 'mesh') {
        scopeTarget = parent.currentNode.meshid;
      } else if (scope == 'node') {
        scopeTarget = parent.currentNode._id;
      }
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'newVar', name:
          name, scope: scope, scopeTarget: scopeTarget, value: value, currentNodeId: parent.currentNode._id
      });

    }
    function newVar() {
      parent.setDialogMode(2, "New Variable", 3, newVarEx, `Variable Name: <input type="text" id=stvarname /><br />Scope: <select id=stvarscope><option value="global">Global</option><option value="script">Script</option><option value="mesh">Mesh</option><option value="node">Node</option></select><br />Value: <input id="stvarvalue" type="text" />`);
      parent.focusTextBox('stvarname');
    }
    function editVarEx() {
      var varid = parent.document.getElementById('stvarid').value;
      var name = parent.document.getElementById('stvarname').value;
      var scope = parent.document.getElementById('stvarscope').value;
      var value = parent.document.getElementById('stvarvalue').value;
      var scopeTarget = null;
      if (scope == 'script') {
        var scriptEl = document.querySelectorAll('.liselected');
        if (scriptEl.length != 1) return;
        var el = scriptEl[0];
        scopeTarget = el.getAttribute('x-data-id');
      } else if (scope == 'mesh') {
        scopeTarget = parent.currentNode.meshid;
      } else if (scope == 'node') {
        scopeTarget = parent.currentNode._id;
      }
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'editVar', id:
          varid, name: name, scope: scope, scopeTarget: scopeTarget, value: value, currentNodeId:
          parent.currentNode._id
      });
    }
    function editVar(el) {
      var vid = el.parentNode.parentNode.getAttribute('x-data-id');
      var v = variables.filter(obj => { return obj._id === vid })[0];
      var soptHtml = '';
      for (const [k, t] of Object.entries(varScopes)) {
        soptHtml += '<option value="' + k + '"';
        if (v.scope == k) soptHtml += ' selected'; soptHtml += '>' + t + '</option>';
      }
      parent.setDialogMode(2, "Edit Variable", 3,
        editVarEx, 'Variable Name: <input type="text" id=stvarname value="' + v.name
        + '" /><br />Scope: <select id=stvarscope>' + soptHtml
        + '</select><br />Value: <input id="stvarvalue" type="text" value="' + v.value
        + '" /><input type="hidden" id="stvarid" value="' + vid + '" />');
      parent.focusTextBox('stvarname');
    } function delVarEx() {
      var
        varid = parent.document.getElementById('stvarid').value; parent.meshserver.send({
          action: 'plugin'
          , plugin: 'scripttask', pluginaction: 'deleteVar', id: varid, currentNodeId:
            parent.currentNode._id
        });
    } function delVar(el) {
      var
        vid = el.parentNode.parentNode.getAttribute('x-data-id'); var v = variables.filter(obj => {
          return
          obj._id === vid
        })[0];
      parent.setDialogMode(2, "Delete Variable", 3, delVarEx, `Are you sure you want to delete
                        this ?<input type="hidden" id="stvarid" value="` + vid + `" /><br />Name: ` + v.name +
        `<br />Scope: ` + varScopes[v.scope] + `<br />Value: ` + v.value);
    }
    function renameEx() {
      var name = parent.document.getElementById('stfilename').value;
      var id = parent.document.getElementById('stid').value;
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'rename', name:
          name, id: id, currentNodeId: parent.currentNode._id
      });
    }
    function goRename() {
      var scriptEl = document.querySelectorAll('.liselected');
      if (scriptEl.length != 1) return;
      var el = scriptEl[0];
      var name = el.querySelector('.fname').innerHTML;
      var id = el.getAttribute('x-data-id');
      parent.setDialogMode(2, "Rename " + name, 3, renameEx, `<input type="text" value="` + name + `"
            style = "width:100%" id = "stfilename" /> <input type="hidden" id="stid" value="` + id + `" />`);
      parent.focusTextBox('stfilename');
    }
    function newEx() {
      var name = parent.document.getElementById('stfilename').value;
      var parent_id = parent.document.getElementById('stfolderid').value;
      var fileType = parent.document.getElementById('stfiletype').value;
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'new', name:
          name, parent_id: parent_id, filetype: fileType, currentNodeId: parent.currentNode._id
      });
    }
    function goNew() {
      var scriptEl = document.querySelectorAll('.liselected');
      var folder_id = null;
      if (scriptEl.length > 0) {
        var el = scriptEl[0];
        folder_id = el.getAttribute('x-data-folder');
      }
      parent.setDialogMode(2, "New Script", 3, newEx, `Name: <input type="text" value="` + name + `"
                          id = stfilename style = width: 100 % /><br / > Type:<select id="stfiletype">
                          <option value="bash">Bash</option>
                          <option value="bat">BAT</option>
                          <option value="ps1">PS1</option>
                        </select><input type="hidden" id="stfolderid" value="` + folder_id + `" />`);
      parent.focusTextBox('stfilename');
    }
    function newFolderEx() {
      var name = parent.document.getElementById('stfoldername').value;
      var parent_id = parent.document.getElementById('stfolderid').value;
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'newFolder',
        name: name, parent_id: parent_id
      });
    }
    function goNewFolder() {
      var scriptEl = document.querySelectorAll('.liselected');
      var folder_id = null;
      if (scriptEl.length > 0) {
        var el = scriptEl[0];
        folder_id = el.getAttribute('x-data-folder');
      }
      parent.setDialogMode(2, "New Folder", 3, newFolderEx, `<input type="text" value=""
                          id = stfoldername style = width: 100 % /><input type="hidden" id="stfolderid"
                          value = "${folder_id}" /> `);
      parent.focusTextBox('stfoldername');
    }
    function goScript(el) {
      var xdi = el.getAttribute('x-data-id');
      var scriptEls = document.querySelectorAll('.liselected');
      parent.putstore('_scripttask_sel_item', xdi);
      scriptEls.forEach(function (e) {
        e.classList.remove('liselected');
      })
      el.classList.add('liselected');
      Q('scriptHistory').setAttribute('x-data-id', el.getAttribute('x-data-id'));
      if (xdi != el.getAttribute('x-data-folder')) {
        parent.meshserver.send({
          action: 'plugin', plugin: 'scripttask', pluginaction:
            'loadScriptHistory', scriptId: xdi
        });
      }
      parseVariables();
    }
    function deleteEx() {
      var id = parent.document.getElementById('stdelid').value;
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'delete', id: id
      });
    }
    function goDelete() {
      var els = document.querySelectorAll('.liselected');
      if (els.length == 0) return;
      var el = els[0];
      var name = el.innerHTML;
      var id = el.getAttribute('x-data-id');
      parent.setDialogMode(2, "Delete " + name, 3, deleteEx, `Are you sure? <input type="hidden"
                          id = "stdelid" value = "${id}" /> `);
    }
    function deleteScheduleEx() {
      var id = parent.document.getElementById('stdelid').value;
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'delete', id: id
      });
    }
    function deleteSchedule(el) {
      var id = el.parentNode.parentNode.getAttribute('x-data-id');
      parent.setDialogMode(2, "Delete Schedule", 3, deleteScheduleEx, `Are you sure you want to delete
                        this schedule ? <input type="hidden" id="stdelid" value="${id}" />`);
    }
    function toggleCollapse(el) {
      var xdf = el.getAttribute('x-data-path');
      var folderEls = document.querySelectorAll('.lifolder, .liscript');
      var showHide = null;
      folderEls.forEach(function (e) {
        if (e === el) return;
        if (e.getAttribute('x-data-path').indexOf(xdf) !== -1) {
          if (e.style.display == 'none') {
            if (showHide === null) showHide = '';
          } else {
            if (showHide === null) showHide = 'none';
          }
          e.style.display = showHide;
        }
      });
      goScript(el);
    }
    function handleFileSelect(evt) {
      evt.preventDefault();
      var files = evt.dataTransfer.files; // FileList object
      // files is a FileList of File objects. List some properties.
      QV('dropBlock', false);
      var output = [];
      fileUpload(files);
      elementDragged = false;
      if (dragTimer != null) dragTimer = null;
      //document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
    }

    function fileUpload(files) {
      if (files == null) files = document.getElementById('files').files;
      var path = null;
      var isSelected = document.querySelectorAll('.liselected');
      if (isSelected.length) {
        var sel = isSelected[0];
        path = sel.getAttribute('x-data-path');
      }
      for (var i = 0, f; f = files[i]; i++) {
        var reader = new FileReader();
        reader.fileName = f.name;
        reader.readAsBinaryString(f);
        reader.addEventListener('loadend', function (e, file) {
          addScript(e.currentTarget.fileName, e.currentTarget.result, path);
        });
      }
    }

    var dropZone = document.getElementById('scriptTaskUser');
    var dropBlock = document.getElementById('dropBlock');
    var dragTimer = null;
    function allowDrag(e) {
      if (!elementDragged) { // Test that the item being dragged is a valid one
        e.dataTransfer.dropEffect = 'copy';
        QV('dropBlock', true);
        e.preventDefault();
        clearTimeout(dragTimer);
        dragTimer = setTimeout(function () { dragCounter = 0; QV('dropBlock', false); }, 100);
      }
    }

    function dropMove(evt) {
      const move_id = evt.dataTransfer.getData('text');
      const container_id = evt.target.parentNode.getAttribute('x-data-id');
      parent.meshserver.send({
        action: 'plugin', plugin: 'scripttask', pluginaction: 'move', id:
          move_id, to: container_id
      });
    }
    // file upload events
    window.addEventListener('dragenter', function (e) {
      dragCounter++;
    });
    dropZone.addEventListener('dragenter', allowDrag);
    dropZone.addEventListener('dragover', allowDrag);
    dropZone.addEventListener('dragleave', function (e) {
      dragCounter--;
      if (dragCounter == 0) {
        QV('dropBlock', false);
        elementDragged = false;
      }
    });
    dropZone.addEventListener('drop', handleFileSelect);

  </script>

</html>